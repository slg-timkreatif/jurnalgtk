<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Jurnal Guru</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS untuk Export & Import Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- HEIC2ANY untuk Support iPhone (.heic to .jpg) -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
    
    <style>
        /* Custom Spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .hidden { display: none !important; }
        
        /* Scrollbar custom untuk riwayat di desktop */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800 font-sans">

    <!-- CONTAINER APLIKASI (Responsive Width) -->
    <div id="app" class="max-w-md md:max-w-6xl w-full mx-auto bg-white min-h-screen shadow-lg relative flex flex-col transition-all duration-300">
        
        <!-- LOADING OVERLAY -->
        <div id="loadingOverlay" class="fixed inset-0 bg-black/50 z-[9999] flex flex-col items-center justify-center hidden">
            <div class="bg-white p-5 rounded-lg flex flex-col items-center shadow-xl">
                <div class="loader mb-3"></div>
                <p id="loadingText" class="text-sm font-semibold text-gray-700">Memuat...</p>
            </div>
        </div>

        <!-- HALAMAN LOGIN (Tetap Centered & Narrow) -->
        <div id="loginPage" class="hidden p-8 flex flex-col justify-center min-h-screen relative max-w-md mx-auto w-full">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-blue-600">E-Jurnal Guru</h1>
                <p class="text-gray-500 text-sm mt-1">Silakan login menggunakan Email & PIN</p>
            </div>

            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="loginEmail" required class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none" placeholder="guru@sekolah.sch.id">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">PIN</label>
                    <input type="password" id="loginPin" required class="mt-1 block w-full rounded-md border border-gray-300 px-3 py-2 focus:border-blue-500 focus:outline-none" placeholder="PIN Rahasia">
                </div>
                <button type="submit" class="w-full py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-md font-medium transition-colors">
                    MASUK
                </button>
                <div id="loginError" class="text-red-500 text-xs text-center hidden"></div>
            </form>

            <div class="mt-8 p-4 bg-blue-50 rounded text-xs text-blue-800">
                <p><strong>Info:</strong> Akun dikelola oleh Admin Sekolah. Hubungi Admin jika lupa PIN atau Email.</p>
            </div>

            <!-- AREA ADMIN SYNC DATABASE GURU (Hidden Trigger) -->
            <div class="absolute bottom-2 right-2 opacity-50 hover:opacity-100">
                <button onclick="handleSyncUsers()" class="text-gray-300 hover:text-blue-500 flex items-center text-xs gap-1" title="Admin: Sinkronisasi Database Guru dari SS">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 21h5v-5"/></svg>
                    Sync DB
                </button>
            </div>
        </div>

        <!-- HALAMAN DASHBOARD -->
        <div id="dashboardPage" class="hidden pb-20 flex-1 flex flex-col h-screen">
            <!-- Header -->
            <div class="bg-blue-600 text-white p-4 sticky top-0 z-10 shadow-md shrink-0">
                <div class="flex justify-between items-start max-w-6xl mx-auto w-full">
                    <div>
                        <h2 class="font-bold text-lg leading-tight" id="userDisplayName">Nama Guru</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs bg-blue-800 px-1.5 py-0.5 rounded text-blue-100" id="userDisplayRole">Guru</span>
                            <p class="text-xs opacity-90" id="userDisplayMeta">Sekolah</p>
                        </div>
                        <p class="text-[10px] opacity-70 mt-0.5" id="userDisplayNip">NIP: -</p>
                    </div>
                    <div class="flex">
                        <button onclick="fetchReferences()" class="text-blue-100 hover:text-white p-2" title="Refresh Data Referensi">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/></svg>
                        </button>
                        <button onclick="handleLogout()" class="text-white bg-blue-700 p-2 rounded hover:bg-blue-800 ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Content Area (Grid Layout on Desktop) -->
            <div class="flex-1 overflow-hidden">
                <div class="h-full overflow-y-auto md:overflow-hidden md:flex md:flex-row p-4 gap-6 max-w-6xl mx-auto">
                    
                    <!-- KOLOM KIRI: FORM INPUT -->
                    <div class="md:w-5/12 md:h-full md:overflow-y-auto custom-scroll mb-6 md:mb-0">
                        <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                            <h3 class="font-semibold text-gray-700 mb-3 border-b pb-2 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                                Input Jurnal Baru
                            </h3>
                            
                            <form id="jurnalForm" class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs font-semibold text-gray-600">Tanggal</label>
                                        <input type="date" id="inpDate" required class="w-full text-sm border rounded p-2 focus:ring-1 focus:ring-blue-500 focus:outline-none">
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-gray-600">Jam</label>
                                        <input type="time" id="inpTime" required class="w-full text-sm border rounded p-2 focus:ring-1 focus:ring-blue-500 focus:outline-none">
                                    </div>
                                </div>

                                <div>
                                    <label class="text-xs font-semibold text-gray-600">Kegiatan</label>
                                    <!-- Bank Uraian Dropdown -->
                                    <div class="mb-2">
                                        <select id="bankActivity" class="w-full text-xs border rounded p-2 text-gray-600 bg-gray-50 focus:border-blue-500 focus:outline-none">
                                            <option value="">-- Pilih dari Bank Kegiatan (Opsional) --</option>
                                            <!-- Options populated via JS -->
                                        </select>
                                    </div>
                                    <textarea id="inpActivity" required rows="3" class="w-full text-sm border rounded p-2 focus:ring-1 focus:ring-blue-500 focus:outline-none" placeholder="Mengajar kelas X..."></textarea>
                                </div>

                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs font-semibold text-gray-600">Volume & Satuan</label>
                                        <div class="flex">
                                            <input type="number" id="inpVolume" placeholder="1" class="w-1/2 text-sm border rounded-l p-2 focus:ring-1 focus:ring-blue-500 focus:outline-none">
                                            <input type="text" id="inpUnit" placeholder="Jam/Dok" class="w-1/2 text-sm border rounded-r p-2 bg-gray-50 focus:ring-1 focus:ring-blue-500 focus:outline-none">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-xs font-semibold text-gray-600">Output</label>
                                        <input type="text" id="inpOutput" list="listOutput" placeholder="Terlaksana" class="w-full text-sm border rounded p-2 focus:ring-1 focus:ring-blue-500 focus:outline-none">
                                        <datalist id="listOutput">
                                            <!-- Options populated via JS -->
                                        </datalist>
                                    </div>
                                </div>

                                <!-- Upload Foto Custom (Support HEIC) -->
                                <div>
                                    <label class="text-xs font-semibold text-gray-600 mb-1 block">Bukti Foto (Wajib)</label>
                                    <div class="flex items-center space-x-2">
                                        <label class="flex-1 cursor-pointer bg-blue-50 hover:bg-blue-100 text-blue-600 rounded border border-dashed border-blue-300 p-3 flex items-center justify-center text-sm transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                            <span id="labelPhoto">Ambil / Pilih Foto</span>
                                            <!-- Update ACCEPT attribute for HEIC -->
                                            <input type="file" id="inpPhoto" accept="image/*,.heic,.heif" class="hidden">
                                        </label>
                                    </div>
                                    <!-- Preview Image -->
                                    <div id="photoPreviewContainer" class="hidden mt-2 relative inline-block">
                                        <img id="photoPreview" class="h-32 w-auto rounded border shadow-sm object-cover" />
                                        <button type="button" onclick="clearPhoto()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow hover:bg-red-600 transition">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                        </button>
                                        <p class="text-[10px] text-green-600 mt-1 font-mono" id="photoSizeInfo"></p>
                                    </div>
                                </div>

                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded font-medium shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">
                                    SIMPAN JURNAL
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- KOLOM KANAN: LIST DATA -->
                    <div class="md:w-7/12 md:h-full md:overflow-y-auto custom-scroll pb-20 md:pb-0">
                        <div class="flex justify-between items-center mb-3 bg-white/80 p-2 rounded backdrop-blur-sm sticky top-0 z-10">
                            <h3 class="font-bold text-gray-800 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-blue-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                                Riwayat Jurnal
                            </h3>
                            <div class="flex gap-2">
                                <!-- Import Button -->
                                <button onclick="document.getElementById('importExcelInput').click()" class="bg-yellow-500 hover:bg-yellow-600 text-white text-xs px-3 py-1.5 rounded flex items-center shadow-sm" title="Import Data Excel Lama">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" transform="rotate(180 10 10)"/></svg>
                                    Import
                                </button>
                                <input type="file" id="importExcelInput" accept=".xlsx, .xls" class="hidden" onchange="handleImportExcel(this)">
                                
                                <!-- Export Button -->
                                <button onclick="exportExcel()" class="bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1.5 rounded flex items-center shadow-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    Excel
                                </button>
                            </div>
                        </div>
                        <div id="journalList" class="space-y-3 pr-1">
                            <!-- Item Jurnal akan dirender di sini via JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- LOGIC JAVASCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, getDocs, orderBy, Timestamp, writeBatch, doc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ==========================================
        // 1. KONFIGURASI (WAJIB DIISI)
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyAzU42xVCAbez0rsmS4OZOq2zZY0NOun5k",
            authDomain: "jurnal-gtk-2.firebaseapp.com",
            projectId: "jurnal-gtk-2",
            storageBucket: "jurnal-gtk-2.firebasestorage.app",
            messagingSenderId: "769907636874",
            appId: "1:769907636874:web:d65c6ea03cfa2dd7578b73"
        };

        // URL Google Apps Script Web App (UNTUK UPLOAD FOTO & DB GURU)
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycby_c2YlEZuHsYoVhgwVeqvsHh4_IMrXH853vCuSnxI6yJEkThjiU0eQWmpt0esBKeaf/exec";

        // ==========================================
        // 2. INITIALIZATION
        // ==========================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = JSON.parse(localStorage.getItem('guru_user')) || null;
        let currentPhotoBase64 = null;
        
        // Simpan referensi dan setting di memori
        let appRefs = JSON.parse(localStorage.getItem('guru_meta')) || { refs: [], settings: {} };

        const el = (id) => document.getElementById(id);
        const views = {
            login: el('loginPage'),
            dashboard: el('dashboardPage'),
            loading: el('loadingOverlay')
        };

        // ==========================================
        // 3. UTILITY FUNCTIONS
        // ==========================================

        const showLoading = (msg = 'Memuat...') => {
            el('loadingText').innerText = msg;
            views.loading.classList.remove('hidden');
        };

        const hideLoading = () => {
            views.loading.classList.add('hidden');
        };

        const switchView = (viewName) => {
            views.login.classList.add('hidden');
            views.dashboard.classList.add('hidden');
            
            // Adjust container width based on view
            const appContainer = el('app');
            if(viewName === 'login') {
                views.login.classList.remove('hidden');
                // Force login page to be centered/small even on desktop
            }
            if(viewName === 'dashboard') {
                views.dashboard.classList.remove('hidden');
            }
        };

        // ==========================================
        // 4. AUTH LOGIC (EMAIL & PIN)
        // ==========================================

        const checkSession = () => {
            if (currentUser) {
                initDashboard();
            } else {
                switchView('login');
            }
        };

        window.handleLogout = () => {
            if(confirm('Yakin ingin keluar?')) {
                localStorage.removeItem('guru_user');
                currentUser = null;
                switchView('login');
                el('loginForm').reset();
            }
        };

        el('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            // Normalisasi email ke lowercase agar tidak case-sensitive
            const email = el('loginEmail').value.trim().toLowerCase(); 
            const pin = el('loginPin').value;
            const errorDiv = el('loginError');

            showLoading('Memverifikasi...');
            errorDiv.classList.add('hidden');

            try {
                // Query by Email & PIN
                const q = query(
                    collection(db, "users"), 
                    where("email", "==", email),
                    where("pin", "==", pin)
                );

                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    currentUser = { id: userDoc.id, ...userDoc.data() };
                    localStorage.setItem('guru_user', JSON.stringify(currentUser));
                    hideLoading();
                    initDashboard();
                } else {
                    throw new Error("Email atau PIN salah.");
                }
            } catch (err) {
                hideLoading();
                errorDiv.innerText = err.message || "Gagal login. Cek koneksi internet.";
                errorDiv.classList.remove('hidden');
            }
        });

        // ==========================================
        // 5. DASHBOARD & JURNAL LOGIC
        // ==========================================

        const initDashboard = () => {
            el('userDisplayName').innerText = currentUser.nama || 'Guru';
            
            // Menampilkan Jabatan/Role
            const role = currentUser.role ? currentUser.role.toUpperCase() : 'GURU';
            el('userDisplayRole').innerText = role;
            
            const sekolah = currentUser.sekolah || '';
            el('userDisplayMeta').innerText = sekolah;
            el('userDisplayNip').innerText = `NIP: ${currentUser.nip || '-'}`;
            
            const now = new Date();
            el('inpDate').value = now.toISOString().split('T')[0];
            el('inpTime').value = now.toTimeString().slice(0,5);

            // Populate Dropdowns dari Local Storage
            populateReferenceUI();

            // Auto-fetch data referensi terbaru di background
            if(!appRefs.refs || appRefs.refs.length === 0) {
                fetchReferences(true); // silent
            }

            loadJournals();
            switchView('dashboard');
        };

        // --- FETCH REFERENCES ---
        
        window.fetchReferences = async (silent = false) => {
            if (!silent) showLoading("Mengambil Data Referensi...");
            
            try {
                if (GOOGLE_SCRIPT_URL.includes("URL_GOOGLE_APPS_SCRIPT")) {
                    if(!silent) alert("URL Script belum disetting.");
                    return;
                }
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=refs`);
                const json = await response.json();

                if (json.result === 'success') {
                    appRefs = {
                        refs: json.refs || [],
                        settings: json.settings || {}
                    };
                    localStorage.setItem('guru_meta', JSON.stringify(appRefs));
                    populateReferenceUI();
                    if (!silent) alert("Data referensi berhasil diperbarui!");
                } else {
                    throw new Error(json.message || "Gagal mengambil referensi");
                }
            } catch (e) {
                console.error(e);
                if (!silent) alert("Gagal update referensi: " + e.message);
            } finally {
                if (!silent) hideLoading();
            }
        };

        function populateReferenceUI() {
            const bankSelect = el('bankActivity');
            const listOutput = el('listOutput');
            const refs = appRefs.refs || [];

            bankSelect.innerHTML = '<option value="">-- Pilih dari Bank Kegiatan (Opsional) --</option>';
            listOutput.innerHTML = '';
            
            refs.forEach(item => {
                if(item.uraian) {
                    const opt = document.createElement('option');
                    opt.value = item.uraian;
                    opt.innerText = item.uraian.substring(0, 60) + (item.uraian.length>60 ? '...' : '');
                    if(item.output) opt.dataset.output = item.output;
                    bankSelect.appendChild(opt);
                }
            });

            const uniqueOutputs = [...new Set(refs.map(r => r.output).filter(o => o))];
            uniqueOutputs.forEach(outVal => {
                const opt = document.createElement('option');
                opt.value = outVal;
                listOutput.appendChild(opt);
            });
        }

        el('bankActivity').addEventListener('change', function() {
            if(this.value) {
                el('inpActivity').value = this.value;
                const selectedOpt = this.options[this.selectedIndex];
                if(selectedOpt.dataset.output) {
                    el('inpOutput').value = selectedOpt.dataset.output;
                }
            }
        });

        // --- COMPRESSION & HEIC CONVERSION ---

        async function processFile(file) {
            showLoading('Memproses Gambar...');
            
            try {
                let blobToProcess = file;

                // 1. CEK HEIC
                if (file.type === "image/heic" || file.type === "image/heif" || file.name.toLowerCase().endsWith('.heic')) {
                    showLoading('Konversi HEIC...');
                    // Convert HEIC to JPEG using heic2any
                    blobToProcess = await heic2any({
                        blob: file,
                        toType: "image/jpeg",
                        quality: 0.8
                    });
                    
                    // heic2any might return an array if multiple images, handle single
                    if (Array.isArray(blobToProcess)) {
                        blobToProcess = blobToProcess[0];
                    }
                }

                // 2. COMPRESSION
                showLoading('Kompresi...');
                const reader = new FileReader();
                reader.readAsDataURL(blobToProcess);
                
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800; // Agak diperbesar untuk desktop
                        const scaleSize = MAX_WIDTH / img.width;
                        const newWidth = (img.width > MAX_WIDTH) ? MAX_WIDTH : img.width;
                        const newHeight = (img.width > MAX_WIDTH) ? (img.height * scaleSize) : img.height;

                        canvas.width = newWidth;
                        canvas.height = newHeight;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, newWidth, newHeight);

                        const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.5); // Quality 50%
                        currentPhotoBase64 = compressedDataUrl.split(',')[1]; 

                        el('photoPreview').src = compressedDataUrl;
                        el('photoPreviewContainer').classList.remove('hidden');
                        el('labelPhoto').innerText = "Ganti Foto";
                        
                        const sizeInKB = Math.round((currentPhotoBase64.length * 0.75) / 1024);
                        el('photoSizeInfo').innerText = `Ukuran: ~${sizeInKB} KB`;

                        hideLoading();
                    };
                };
            } catch (err) {
                console.error(err);
                alert("Gagal memproses gambar: " + err.message);
                hideLoading();
                clearPhoto();
            }
        }

        el('inpPhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            processFile(file);
        });

        window.clearPhoto = () => {
            el('inpPhoto').value = '';
            currentPhotoBase64 = null;
            el('photoPreviewContainer').classList.add('hidden');
            el('labelPhoto').innerText = "Ambil / Pilih Foto";
        };

        // --- SUBMIT JURNAL ---

        el('jurnalForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentPhotoBase64) {
                alert("Harap lampirkan bukti foto kegiatan!");
                return;
            }

            if (GOOGLE_SCRIPT_URL.includes("URL_GOOGLE_APPS_SCRIPT_ANDA_DISINI")) {
                alert("ERROR: Admin belum menyetting URL Google Apps Script.");
                return;
            }

            showLoading('Upload & Simpan...');

            try {
                // Ambil ID Drive dari Setting
                const driveFolderId = appRefs.settings ? (appRefs.settings['ID Drive'] || appRefs.settings['Folder ID'] || appRefs.settings['Drive ID'] || '') : '';

                const uploadPayload = {
                    base64: currentPhotoBase64,
                    filename: `jurnal_${currentUser.nip.replace(/[^a-zA-Z0-9]/g, '')}_${Date.now()}.jpg`,
                    mimeType: 'image/jpeg',
                    folderId: driveFolderId
                };

                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(uploadPayload)
                });

                const result = await response.json();

                if (result.result !== 'success') {
                    throw new Error("Gagal upload foto: " + (result.message || 'Unknown error'));
                }

                const photoUrl = result.url;

                const jurnalData = {
                    uid: currentUser.id, 
                    nip: currentUser.nip,
                    nama: currentUser.nama,
                    tanggal: el('inpDate').value,
                    jam: el('inpTime').value,
                    kegiatan: el('inpActivity').value,
                    volume: el('inpVolume').value,
                    satuan: el('inpUnit').value,
                    output: el('inpOutput').value,
                    foto: photoUrl,
                    role: currentUser.role || 'guru', 
                    createdAt: Timestamp.now()
                };

                await addDoc(collection(db, "jurnal"), jurnalData);

                el('jurnalForm').reset();
                clearPhoto();
                const now = new Date();
                el('inpDate').value = now.toISOString().split('T')[0];
                el('inpTime').value = now.toTimeString().slice(0,5);

                alert('Jurnal berhasil disimpan!');
                loadJournals();

            } catch (err) {
                console.error(err);
                alert("Terjadi kesalahan: " + err.message);
            } finally {
                hideLoading();
            }
        });

        // --- LOAD LIST DATA ---

        async function loadJournals() {
            const listContainer = el('journalList');
            listContainer.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">Memuat riwayat...</div>';

            try {
                const q = query(
                    collection(db, "jurnal"),
                    where("uid", "==", currentUser.id),
                    orderBy("createdAt", "desc")
                );

                const querySnapshot = await getDocs(q);
                
                listContainer.innerHTML = '';

                if (querySnapshot.empty) {
                    listContainer.innerHTML = '<div class="text-center text-gray-400 text-sm py-4">Belum ada data jurnal.</div>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const itemHtml = `
                        <div class="bg-white p-3 rounded border shadow-sm text-sm hover:shadow-md transition-shadow">
                            <div class="flex justify-between items-start mb-1">
                                <span class="font-bold text-blue-600">${data.tanggal} <span class="text-gray-400 font-normal">| ${data.jam}</span></span>
                                <a href="${data.foto}" target="_blank" class="text-blue-500 hover:text-blue-700 flex items-center text-xs border border-blue-200 px-2 py-1 rounded bg-blue-50 hover:bg-blue-100 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                                    Foto
                                </a>
                            </div>
                            <p class="text-gray-800 font-medium mb-1 break-words">${data.kegiatan}</p>
                            <div class="flex justify-between text-xs text-gray-500 mt-2 pt-2 border-t border-dashed">
                                <span>Vol: ${data.volume} ${data.satuan}</span>
                                <span>Output: ${data.output}</span>
                            </div>
                        </div>
                    `;
                    listContainer.innerHTML += itemHtml;
                });

            } catch (err) {
                console.error("Error loading journals:", err);
                listContainer.innerHTML = '<div class="text-center text-red-400 text-xs py-4">Gagal memuat data.</div>';
            }
        }

        // --- EXPORT & IMPORT EXCEL ---
        // (Function tetap sama, disederhanakan untuk mempersingkat tampilan code di sini jika tidak berubah logic)
        
        window.exportExcel = async () => {
             if(!confirm("Download rekap jurnal Anda ke Excel?")) return;
            showLoading("Menyiapkan Excel...");
            try {
                const q = query(collection(db, "jurnal"), where("uid", "==", currentUser.id), orderBy("tanggal", "desc"));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) { alert("Tidak ada data."); hideLoading(); return; }

                const dataForExcel = [];
                querySnapshot.forEach(doc => {
                    const d = doc.data();
                    dataForExcel.push({
                        "Tanggal": d.tanggal, "Jam": d.jam, "NIP": d.nip, "Nama Guru": d.nama,
                        "Jabatan": currentUser.jabatan || '-', "Sekolah": currentUser.sekolah || '-',
                        "Kegiatan": d.kegiatan, "Volume": d.volume, "Satuan": d.satuan,
                        "Output": d.output, "Link Foto": d.foto
                    });
                });

                const kota = (appRefs.settings && appRefs.settings['Kota']) ? appRefs.settings['Kota'] : '........';
                const today = new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
                
                dataForExcel.push({}, {}, {});
                dataForExcel.push({ 'Link Foto': `${kota}, ${today}` });
                dataForExcel.push({ 'Link Foto': 'Guru Mata Pelajaran' });
                dataForExcel.push({});
                dataForExcel.push({});
                dataForExcel.push({ 'Link Foto': currentUser.nama });
                dataForExcel.push({ 'Link Foto': `NIP. ${currentUser.nip}` });

                const ws = XLSX.utils.json_to_sheet(dataForExcel);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Jurnal Harian");
                XLSX.writeFile(wb, `Jurnal_${currentUser.nama.replace(/\s+/g, '_')}_${Date.now()}.xlsx`);
            } catch(err) { console.error(err); alert("Gagal export excel."); } finally { hideLoading(); }
        };

        function parseIndoDate(dateStr) {
             if (!dateStr || typeof dateStr !== 'string') return null;
             const months = { 'Januari': '01', 'Februari': '02', 'Maret': '03', 'April': '04', 'Mei': '05', 'Juni': '06', 'Juli': '07', 'Agustus': '08', 'September': '09', 'Oktober': '10', 'November': '11', 'Desember': '12'};
             try {
                const parts = dateStr.includes(',') ? dateStr.split(',')[1].trim().split(' ') : dateStr.trim().split(' ');
                if (parts.length < 3) return null;
                return `${parts[2]}-${months[parts[1]] || '01'}-${parts[0].padStart(2, '0')}`;
             } catch(e) { return null; }
        }

        window.handleImportExcel = async (input) => {
            const file = input.files[0];
            if (!file) return;
            if(!confirm("Import data?")) { input.value = ''; return; }
            showLoading("Menganalisa Excel...");
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    if (rawData.length === 0) throw new Error("File kosong.");

                    let headerRowIndex = -1, colMap = { date: -1, time: -1, activity: -1, output: -1, link: -1 };
                    for (let i = 0; i < Math.min(rawData.length, 20); i++) {
                        const row = rawData[i].map(c => String(c).toLowerCase());
                        if (row.some(c=>c.includes('tanggal')) && row.some(c=>c.includes('kegiatan'))) {
                            headerRowIndex = i;
                            colMap.date = row.findIndex(c => c.includes('tanggal'));
                            colMap.activity = row.findIndex(c => c.includes('kegiatan'));
                            colMap.time = row.findIndex(c => c.includes('waktu'));
                            colMap.output = row.findIndex(c => c.includes('hasil') || c.includes('output'));
                            colMap.link = row.findIndex(c => c.includes('foto'));
                            break;
                        }
                    }
                    if (headerRowIndex === -1) throw new Error("Format tabel tidak dikenali.");

                    const promises = [];
                    for (let i = headerRowIndex + 1; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (!row || !row[colMap.activity]) continue;
                        let rawDate = row[colMap.date], finalDate = '';
                        if (typeof rawDate === 'number') finalDate = new Date(Math.round((rawDate - 25569)*86400*1000)).toISOString().split('T')[0];
                        else if (typeof rawDate === 'string') finalDate = parseIndoDate(rawDate) || new Date().toISOString().split('T')[0];
                        else continue;

                        let finalTime = '07:00';
                        if(row[colMap.time]) finalTime = String(row[colMap.time]).split('-')[0].trim();

                        promises.push(addDoc(collection(db, "jurnal"), {
                            uid: currentUser.id, nip: currentUser.nip, nama: currentUser.nama,
                            tanggal: finalDate, jam: finalTime, kegiatan: row[colMap.activity],
                            volume: '1', satuan: 'Kegiatan', output: row[colMap.output] || 'Terlaksana',
                            foto: row[colMap.link] || '', role: currentUser.role || 'guru', createdAt: Timestamp.now()
                        }));
                    }
                    await Promise.all(promises);
                    alert("Import berhasil."); loadJournals();
                } catch (err) { alert("Gagal Import: " + err.message); } finally { hideLoading(); input.value = ''; }
            };
            reader.readAsArrayBuffer(file);
        };

        window.handleSyncUsers = async () => {
            const adminPass = prompt("Password Admin:");
            if (adminPass !== "admin123") { alert("Password salah."); return; }
            const scriptUrl = prompt("URL Google Apps Script:", GOOGLE_SCRIPT_URL);
            if (!scriptUrl) return;
            showLoading("Sinkronisasi...");
            try {
                const response = await fetch(`${scriptUrl}?action=users`);
                const json = await response.json();
                if (json.result !== 'success') throw new Error(json.message);
                const batch = writeBatch(db);
                json.data.forEach(user => {
                    const nip = String(user['NIP']).trim();
                    if (!nip) return;
                    let role = 'guru';
                    const jabatan = (user['Jabatan']||'').toLowerCase();
                    if(user['Role']) role = user['Role'].toLowerCase();
                    else if(jabatan.includes('kepala sekolah')) role = 'ks';
                    else if(jabatan.includes('admin') || jabatan.includes('operator')) role = 'admin';
                    
                    batch.set(doc(db, "users", nip), {
                        nama: user['Nama Lengkap'], nip: nip, pin: String(user['PIN']),
                        jabatan: user['Jabatan'], sekolah: user['Satuan Pendidikan'],
                        email: String(user['Email']).toLowerCase(), role: role, updatedAt: Timestamp.now()
                    }, { merge: true });
                });
                await batch.commit();
                await fetchReferences(true);
                alert("Sinkronisasi Berhasil!");
            } catch (err) { alert("Gagal: " + err.message); } finally { hideLoading(); }
        };

        checkSession();

    </script>
</body>
</html>
