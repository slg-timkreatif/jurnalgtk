<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jurnal Guru & Tendik (Smart Save)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Glassmorphism utilities */
        .glass {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #1e3a8a;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden flex flex-col">

    <!-- App Container -->
    <div id="app" class="flex-1 flex flex-col h-full relative overflow-hidden">
        
        <!-- Login Screen (Hidden by default) -->
        <div id="login-screen" class="absolute inset-0 z-50 bg-slate-50 flex flex-col items-center justify-center p-6 hidden">
            <div class="text-center max-w-md w-full">
                <div class="bg-blue-100 p-4 rounded-full inline-flex mb-6">
                    <i data-lucide="book-open" class="w-12 h-12 text-blue-800"></i>
                </div>
                <h1 class="text-3xl font-bold text-slate-900 mb-2">Jurnal Guru</h1>
                <p class="text-slate-500 mb-8">Catat kegiatan harian, simpan di Google Drive, dan buat laporan otomatis.</p>
                
                <button id="btn-login" class="w-full bg-blue-800 hover:bg-blue-900 text-white font-semibold py-4 rounded-xl shadow-lg flex items-center justify-center gap-3 transition-all transform active:scale-95">
                    <i data-lucide="log-in" class="w-5 h-5"></i>
                    Masuk dengan Google
                </button>
                <p class="text-xs text-slate-400 mt-6">Aplikasi ini membutuhkan akses ke Google Drive & Sheets Anda untuk menyimpan data secara mandiri.</p>
            </div>
        </div>

        <!-- Main Layout (Dashboard) -->
        <div id="main-layout" class="flex-1 flex flex-col h-full hidden">
            <!-- Header -->
            <header class="bg-white border-b border-slate-200 px-4 py-3 flex items-center justify-between shadow-sm z-10">
                <div class="flex items-center gap-3">
                    <img id="user-avatar" src="" alt="User" class="w-8 h-8 rounded-full bg-slate-200 object-cover hidden">
                    <div>
                        <h2 class="font-bold text-slate-800 text-sm leading-tight" id="user-name">Memuat...</h2>
                        <p class="text-xs text-slate-500" id="current-date">...</p>
                    </div>
                </div>
                <button id="btn-logout" class="text-slate-400 hover:text-red-500 p-2">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </header>

            <!-- Scrollable Content -->
            <main class="flex-1 overflow-y-auto p-4 pb-24 relative" id="journal-list">
                <!-- Empty State -->
                <div id="empty-state" class="hidden flex flex-col items-center justify-center h-64 text-center mt-10">
                    <div class="bg-slate-100 p-4 rounded-full mb-4">
                        <i data-lucide="clipboard-list" class="w-8 h-8 text-slate-400"></i>
                    </div>
                    <p class="text-slate-500 font-medium">Belum ada jurnal hari ini</p>
                    <p class="text-slate-400 text-sm mt-1">Tap tombol + untuk mulai menulis</p>
                </div>

                <!-- Loading Spinner -->
                <div id="loading-indicator" class="flex flex-col items-center justify-center py-10 hidden">
                    <div class="loader mb-2"></div>
                    <p class="text-xs text-slate-500">Menyingkronkan data...</p>
                </div>

                <!-- Journal Items Container -->
                <div id="journal-container" class="space-y-4"></div>
            </main>

            <!-- Floating Action Button -->
            <button id="btn-add" class="absolute bottom-6 right-6 bg-blue-800 hover:bg-blue-700 text-white w-14 h-14 rounded-full shadow-xl flex items-center justify-center transition-transform active:scale-90 z-20">
                <i data-lucide="plus" class="w-8 h-8"></i>
            </button>
        </div>

        <!-- Form Modal (Slide Up) -->
        <div id="form-modal" class="fixed inset-0 z-40 hidden">
            <!-- Backdrop -->
            <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" id="form-backdrop"></div>
            
            <!-- Modal Content -->
            <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl h-[90vh] flex flex-col shadow-2xl transform transition-transform duration-300 translate-y-full" id="form-content">
                
                <!-- Modal Header -->
                <div class="flex items-center justify-between px-4 py-3 border-b border-slate-100">
                    <button id="btn-close-form" class="text-slate-400 p-2 hover:bg-slate-50 rounded-full">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <h3 class="font-bold text-slate-800">Jurnal Baru</h3>
                    <button id="btn-save" class="text-blue-700 font-bold text-sm px-3 py-1 hover:bg-blue-50 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        SIMPAN
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="flex-1 overflow-y-auto p-5 space-y-5">
                    
                    <!-- Date & Time -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">TANGGAL</label>
                            <input type="date" id="input-date" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1">JAM (Mulai - Selesai)</label>
                            <div class="flex items-center gap-2">
                                <input type="time" id="input-time-start" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-sm text-center">
                                <span class="text-slate-300">-</span>
                                <input type="time" id="input-time-end" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-2 py-2 text-sm text-center">
                            </div>
                        </div>
                    </div>

                    <!-- Activity -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">KEGIATAN</label>
                        <textarea id="input-activity" rows="3" placeholder="Apa yang Anda kerjakan hari ini?" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"></textarea>
                    </div>

                    <!-- Result -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">HASIL / OUTPUT</label>
                        <textarea id="input-result" rows="2" placeholder="Dokumen, Laporan, Terselesaikannya..." class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-colors"></textarea>
                    </div>

                    <!-- Photo Upload -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 mb-1">DOKUMENTASI</label>
                        
                        <div id="upload-area" class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:bg-slate-50 transition-colors cursor-pointer relative overflow-hidden">
                            <input type="file" id="input-photo" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10">
                            
                            <!-- Placeholder -->
                            <div id="upload-placeholder" class="flex flex-col items-center">
                                <div class="bg-blue-50 p-3 rounded-full mb-2">
                                    <i data-lucide="camera" class="w-6 h-6 text-blue-600"></i>
                                </div>
                                <span class="text-sm font-medium text-slate-600">Ambil Foto / Upload</span>
                                <span class="text-xs text-slate-400 mt-1">Otomatis dikompres (Hemat Kuota)</span>
                            </div>

                            <!-- Preview -->
                            <div id="upload-preview" class="hidden flex-col items-center relative z-0">
                                <img id="img-preview" src="" class="h-40 rounded-lg shadow-sm object-cover mb-2">
                                <span id="file-size-info" class="text-xs text-green-600 font-medium bg-green-50 px-2 py-1 rounded"></span>
                                <button type="button" id="btn-remove-photo" class="text-xs text-red-500 mt-2 hover:underline z-20 relative">Hapus Foto</button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div id="toast" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3 z-50 transition-all duration-300 translate-y-20 opacity-0">
            <i id="toast-icon" data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
            <span id="toast-message" class="text-sm font-medium">Berhasil disimpan</span>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://apis.google.com/js/api.js" defer></script>
    <script src="https://accounts.google.com/gsi/client" defer></script>
    <script>
        // --- Configuration ---
        // PENTING: Ganti string di bawah ini dengan API KEY Anda sendiri jika di-deploy ke GitHub Pages
        const ENV_API_KEY = (typeof process !== 'undefined' && process.env && process.env.API_KEY) 
            ? process.env.API_KEY 
            : 'ISI_API_KEY_ANDA_DISINI'; 

        const CONFIG = {
          CLIENT_ID: '937175233633-pv3133863484814981881.apps.googleusercontent.com', 
          API_KEY: ENV_API_KEY, 
          SCOPES: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets',
          DB_FILENAME: 'JurnalGuru_Database_v2',
          FOLDER_NAME: 'JurnalGuru_Foto_v2'
        };

        // --- State Management ---
        const state = {
          user: null,
          tokenClient: null,
          gapiInited: false,
          gisInited: false,
          files: {
            spreadsheetId: localStorage.getItem('jg_ssid') || null,
            folderId: localStorage.getItem('jg_fid') || null,
          },
          journalData: [],
          isSubmitting: false,
        };

        // --- DOM Elements ---
        const els = {
          app: document.getElementById('app'),
          loginScreen: document.getElementById('login-screen'),
          mainLayout: document.getElementById('main-layout'),
          btnLogin: document.getElementById('btn-login'),
          btnLogout: document.getElementById('btn-logout'),
          userAvatar: document.getElementById('user-avatar'),
          userName: document.getElementById('user-name'),
          currentDate: document.getElementById('current-date'),
          journalList: document.getElementById('journal-list'),
          journalContainer: document.getElementById('journal-container'),
          loadingIndicator: document.getElementById('loading-indicator'),
          emptyState: document.getElementById('empty-state'),
          btnAdd: document.getElementById('btn-add'),
          formModal: document.getElementById('form-modal'),
          formContent: document.getElementById('form-content'),
          formBackdrop: document.getElementById('form-backdrop'),
          btnCloseForm: document.getElementById('btn-close-form'),
          btnSave: document.getElementById('btn-save'),
          inputs: {
            date: document.getElementById('input-date'),
            timeStart: document.getElementById('input-time-start'),
            timeEnd: document.getElementById('input-time-end'),
            activity: document.getElementById('input-activity'),
            result: document.getElementById('input-result'),
            photo: document.getElementById('input-photo'),
          },
          uploadUI: {
            area: document.getElementById('upload-area'),
            placeholder: document.getElementById('upload-placeholder'),
            preview: document.getElementById('upload-preview'),
            img: document.getElementById('img-preview'),
            info: document.getElementById('file-size-info'),
            removeBtn: document.getElementById('btn-remove-photo')
          },
          toast: document.getElementById('toast'),
          toastMsg: document.getElementById('toast-message'),
          toastIcon: document.getElementById('toast-icon')
        };

        // --- Utility: Date Formatting ---
        const formatDate = (dateStr) => {
          const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
          return new Date(dateStr).toLocaleDateString('id-ID', options);
        };

        const getTodayString = () => new Date().toISOString().split('T')[0];
        const getTimeString = () => new Date().toTimeString().slice(0, 5);

        // --- Utility: Image Compression (The Fix) ---
        async function compressImage(file) {
          return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
              const img = new Image();
              img.src = event.target.result;
              img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1024;
                const MAX_HEIGHT = 1024;
                let width = img.width;
                let height = img.height;

                if (width > height) {
                  if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                  }
                } else {
                  if (height > MAX_HEIGHT) {
                    width *= MAX_HEIGHT / height;
                    height = MAX_HEIGHT;
                  }
                }

                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);

                // Compress to JPEG 70% quality
                canvas.toBlob((blob) => {
                  if (blob) resolve(blob);
                  else reject(new Error('Compression failed'));
                }, 'image/jpeg', 0.7);
              };
              img.onerror = (err) => reject(err);
            };
            reader.onerror = (err) => reject(err);
          });
        }

        // --- Utility: Toast Notification ---
        function showToast(message, type = 'success') {
          els.toastMsg.innerText = message;
          els.toastIcon.innerHTML = type === 'success' 
            ? `<polyline points="20 6 9 17 4 12"></polyline>` // check
            : `<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>`; // x
          
          // Re-render icon
          lucide.createIcons();

          els.toast.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-4 py-3 rounded-lg shadow-2xl flex items-center gap-3 z-50 transition-all duration-300 ${type === 'success' ? 'bg-slate-800 text-white' : 'bg-red-600 text-white'}`;
          
          // Show
          requestAnimationFrame(() => {
            els.toast.classList.remove('translate-y-20', 'opacity-0');
          });

          // Hide after 3s
          setTimeout(() => {
            els.toast.classList.add('translate-y-20', 'opacity-0');
          }, 3000);
        }

        // --- API Wrapper with Token Refresh (The Fix) ---
        async function callGoogleApi(apiCall) {
          // Check if token exists
          const token = gapi.client.getToken();
          if (!token) {
            // Force prompt if no token at all
            await new Promise((resolve, reject) => {
              state.tokenClient.callback = (resp) => {
                if (resp.error) reject(resp);
                resolve(resp);
              };
              state.tokenClient.requestAccessToken({ prompt: 'consent' });
            });
          }

          try {
            return await apiCall();
          } catch (error) {
            // If 401 Unauthorized (Token expired), refresh silently
            if (error.status === 401 || (error.result && error.result.error && error.result.error.code === 401)) {
              console.log("Token expired, refreshing...");
              await new Promise((resolve, reject) => {
                 state.tokenClient.callback = (resp) => {
                    if (resp.error) reject(resp);
                    resolve(resp);
                 };
                 // Use empty prompt to try silent refresh, or 'consent' if needed
                 state.tokenClient.requestAccessToken({ prompt: '' });
              });
              // Retry the original call
              return await apiCall();
            }
            throw error;
          }
        }

        // --- Initialization ---
        function gapiLoaded() {
          gapi.load('client', async () => {
            await gapi.client.init({
              apiKey: CONFIG.API_KEY,
              discoveryDocs: [
                'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                'https://sheets.googleapis.com/$discovery/rest?version=v4'
              ],
            });
            state.gapiInited = true;
            checkAuth();
          });
        }

        function gisLoaded() {
          state.tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CONFIG.CLIENT_ID,
            scope: CONFIG.SCOPES,
            callback: '', // defined dynamically
          });
          state.gisInited = true;
          checkAuth();
        }

        function checkAuth() {
          if (state.gapiInited && state.gisInited) {
            // Check localstorage for simple session persistence
            const savedUser = localStorage.getItem('jg_user');
            if (savedUser) {
                state.user = JSON.parse(savedUser);
                showApp();
            } else {
                els.loginScreen.classList.remove('hidden');
            }
            // Initialize icons
            lucide.createIcons();
          }
        }

        // --- Business Logic: Setup Drive/Sheets ---
        async function ensureDriveFiles() {
          // 1. Check/Create Folder
          if (!state.files.folderId) {
            const folderResp = await callGoogleApi(() => gapi.client.drive.files.list({
              q: `mimeType='application/vnd.google-apps.folder' and name='${CONFIG.FOLDER_NAME}' and trashed=false`,
              fields: 'files(id)'
            }));
            
            if (folderResp.result.files && folderResp.result.files.length > 0) {
              state.files.folderId = folderResp.result.files[0].id;
            } else {
              const createResp = await callGoogleApi(() => gapi.client.drive.files.create({
                resource: {
                  name: CONFIG.FOLDER_NAME,
                  mimeType: 'application/vnd.google-apps.folder'
                },
                fields: 'id'
              }));
              state.files.folderId = createResp.result.id;
            }
            localStorage.setItem('jg_fid', state.files.folderId);
          }

          // 2. Check/Create Spreadsheet
          if (!state.files.spreadsheetId) {
            const sheetResp = await callGoogleApi(() => gapi.client.drive.files.list({
              q: `mimeType='application/vnd.google-apps.spreadsheet' and name='${CONFIG.DB_FILENAME}' and trashed=false`,
              fields: 'files(id)'
            }));

            if (sheetResp.result.files && sheetResp.result.files.length > 0) {
              state.files.spreadsheetId = sheetResp.result.files[0].id;
            } else {
              const createResp = await callGoogleApi(() => gapi.client.sheets.spreadsheets.create({
                resource: {
                  properties: { title: CONFIG.DB_FILENAME },
                  sheets: [{
                     properties: { title: 'Sheet1' },
                     data: [{
                        startRow: 0, startColumn: 0,
                        rowData: [{
                           values: [
                              { userEnteredValue: { stringValue: 'Timestamp' } },
                              { userEnteredValue: { stringValue: 'Tanggal' } },
                              { userEnteredValue: { stringValue: 'Jam Mulai' } },
                              { userEnteredValue: { stringValue: 'Jam Selesai' } },
                              { userEnteredValue: { stringValue: 'Kegiatan' } },
                              { userEnteredValue: { stringValue: 'Hasil' } },
                              { userEnteredValue: { stringValue: 'Foto URL' } },
                              { userEnteredValue: { stringValue: 'ID' } }
                           ]
                        }]
                     }]
                  }]
                }
              }));
              state.files.spreadsheetId = createResp.result.spreadsheetId;
            }
            localStorage.setItem('jg_ssid', state.files.spreadsheetId);
          }
        }

        // --- Business Logic: Fetch Data ---
        async function fetchJournalData() {
          if (!state.files.spreadsheetId) return;
          
          els.loadingIndicator.classList.remove('hidden');
          els.emptyState.classList.add('hidden');
          els.journalContainer.innerHTML = '';

          try {
            const response = await callGoogleApi(() => gapi.client.sheets.spreadsheets.values.get({
              spreadsheetId: state.files.spreadsheetId,
              range: 'Sheet1!A2:H', // Dynamic range
            }));

            const rows = response.result.values;
            if (rows && rows.length > 0) {
              // Map rows to objects (reverse to show newest first)
              state.journalData = rows.map((row, index) => ({
                timestamp: row[0],
                date: row[1],
                timeStart: row[2],
                timeEnd: row[3],
                activity: row[4],
                result: row[5],
                photoUrl: row[6],
                id: row[7] || `row-${index}`
              })).reverse();
              
              renderJournalList();
            } else {
              els.emptyState.classList.remove('hidden');
            }
          } catch (err) {
            console.error(err);
            showToast('Gagal memuat data', 'error');
          } finally {
            els.loadingIndicator.classList.add('hidden');
          }
        }

        // --- UI: Render List ---
        function renderJournalList() {
          els.journalContainer.innerHTML = '';
          
          if (state.journalData.length === 0) {
            els.emptyState.classList.remove('hidden');
            return;
          }

          state.journalData.forEach(item => {
            const el = document.createElement('div');
            el.className = 'bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-3';
            
            // Check if it has photo
            const photoHtml = item.photoUrl 
              ? `<div class="mt-3 mb-1"><img src="${item.photoUrl}" class="rounded-lg max-h-48 object-cover w-full bg-slate-100" loading="lazy"></div>` 
              : '';

            el.innerHTML = `
              <div class="flex justify-between items-start mb-2">
                <div>
                  <span class="text-xs font-bold text-blue-700 bg-blue-50 px-2 py-1 rounded-md">${formatDate(item.date)}</span>
                  <span class="text-xs text-slate-400 ml-2">${item.timeStart} - ${item.timeEnd}</span>
                </div>
              </div>
              <h3 class="text-slate-800 font-medium text-sm whitespace-pre-line">${item.activity}</h3>
              ${item.result ? `<p class="text-slate-500 text-xs mt-1 border-l-2 border-slate-200 pl-2">Output: ${item.result}</p>` : ''}
              ${photoHtml}
            `;
            els.journalContainer.appendChild(el);
          });
        }

        // --- Business Logic: Upload & Save ---
        async function saveJournal() {
          if (state.isSubmitting) return;
          
          const date = els.inputs.date.value;
          const activity = els.inputs.activity.value.trim();
          
          if (!date || !activity) {
            showToast('Tanggal dan Kegiatan wajib diisi', 'error');
            return;
          }

          state.isSubmitting = true;
          els.btnSave.textContent = 'MENYIMPAN...';
          els.btnSave.disabled = true;

          try {
            await ensureDriveFiles();

            let photoLink = '';
            const file = els.inputs.photo.files?.[0];

            // 1. Upload Photo if exists
            if (file && state.files.folderId) {
               els.btnSave.textContent = 'UPLOAD FOTO...';
               
               // Compress!
               const compressedBlob = await compressImage(file);
               
               // Prepare Metadata
               const metadata = {
                 name: `IMG_${Date.now()}.jpg`,
                 mimeType: 'image/jpeg',
                 parents: [state.files.folderId]
               };

               // Upload using Multipart
               const accessToken = gapi.client.getToken().access_token;
               const form = new FormData();
               form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
               form.append('file', compressedBlob);

               const uploadRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink,thumbnailLink', {
                 method: 'POST',
                 headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                 body: form
               });
               
               const fileData = await uploadRes.json();
               if(fileData.id) {
                  // Hack for thumbnail link to get higher res
                  photoLink = fileData.thumbnailLink ? fileData.thumbnailLink.replace('=s220', '=s800') : fileData.webViewLink; 
               }
            }

            // 2. Append to Sheet
            els.btnSave.textContent = 'MENULIS DATA...';
            const rowValues = [
              new Date().toISOString(),
              date,
              els.inputs.timeStart.value,
              els.inputs.timeEnd.value,
              activity,
              els.inputs.result.value,
              photoLink,
              'ID-' + Date.now()
            ];

            await callGoogleApi(() => gapi.client.sheets.spreadsheets.values.append({
              spreadsheetId: state.files.spreadsheetId,
              range: 'Sheet1!A2',
              valueInputOption: 'USER_ENTERED',
              insertDataOption: 'INSERT_ROWS',
              resource: {
                values: [rowValues]
              }
            }));

            showToast('Jurnal berhasil disimpan!');
            closeForm();
            await fetchJournalData(); // Refresh list

          } catch (err) {
            console.error(err);
            showToast('Gagal menyimpan. Coba refresh halaman.', 'error');
          } finally {
            state.isSubmitting = false;
            els.btnSave.textContent = 'SIMPAN';
            els.btnSave.disabled = false;
          }
        }

        // --- Auth Actions ---
        async function handleLogin() {
          state.tokenClient.callback = async (resp) => {
            if (resp.error) throw resp;
            
            // Get Profile
            const userInfo = await callGoogleApi(() => 
               fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                  headers: { Authorization: `Bearer ${gapi.client.getToken().access_token}` }
               }).then(res => res.json())
            );

            state.user = userInfo;
            localStorage.setItem('jg_user', JSON.stringify(userInfo));
            showApp();
          };

          // Request token
          state.tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function handleLogout() {
          const token = gapi.client.getToken();
          if (token) {
            google.accounts.oauth2.revoke(token.access_token, () => {
              console.log('Token revoked');
              gapi.client.setToken(null);
              localStorage.removeItem('jg_user');
              localStorage.removeItem('jg_ssid');
              localStorage.removeItem('jg_fid');
              state.user = null;
              els.mainLayout.classList.add('hidden');
              els.loginScreen.classList.remove('hidden');
            });
          }
        }

        function showApp() {
          if (state.user) {
            els.loginScreen.classList.add('hidden');
            els.mainLayout.classList.remove('hidden');
            
            els.userName.innerText = state.user.name;
            els.userAvatar.src = state.user.picture;
            els.userAvatar.classList.remove('hidden');
            
            const d = new Date();
            els.currentDate.innerText = d.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });

            // Initial Fetch
            fetchJournalData();
          }
        }

        // --- Form Interaction ---
        function openForm() {
          els.inputs.date.value = getTodayString();
          els.inputs.timeStart.value = getTimeString();
          els.inputs.timeEnd.value = getTimeString();
          els.inputs.activity.value = '';
          els.inputs.result.value = '';
          els.inputs.photo.value = '';
          
          els.uploadUI.preview.classList.add('hidden');
          els.uploadUI.preview.classList.remove('flex');
          els.uploadUI.placeholder.classList.remove('hidden');
          els.uploadUI.img.src = '';
          
          els.formModal.classList.remove('hidden');
          requestAnimationFrame(() => {
            els.formContent.classList.remove('translate-y-full');
          });
        }

        function closeForm() {
          els.formContent.classList.add('translate-y-full');
          setTimeout(() => {
            els.formModal.classList.add('hidden');
          }, 300);
        }

        // --- File Input Handler ---
        els.inputs.photo.addEventListener('change', async (e) => {
            const target = e.target;
            if (target.files && target.files[0]) {
                const file = target.files[0];
                
                // Show Preview
                els.uploadUI.placeholder.classList.add('hidden');
                els.uploadUI.preview.classList.remove('hidden');
                els.uploadUI.preview.classList.add('flex');
                
                const rawSize = (file.size / 1024).toFixed(0);
                
                // Show temp preview
                const url = URL.createObjectURL(file);
                els.uploadUI.img.src = url;

                try {
                    const compressed = await compressImage(file);
                    const compSize = (compressed.size / 1024).toFixed(0);
                    els.uploadUI.info.innerText = `Asli: ${rawSize}KB -> Hemat: ${compSize}KB`;
                } catch (e) {
                    els.uploadUI.info.innerText = `${rawSize}KB`;
                }
            }
        });

        els.uploadUI.removeBtn.addEventListener('click', (e) => {
            e.stopPropagation(); 
            els.inputs.photo.value = '';
            els.uploadUI.preview.classList.add('hidden');
            els.uploadUI.preview.classList.remove('flex');
            els.uploadUI.placeholder.classList.remove('hidden');
        });

        // --- Event Listeners ---
        els.btnLogin.onclick = handleLogin;
        els.btnLogout.onclick = handleLogout;
        els.btnAdd.onclick = openForm;
        els.btnCloseForm.onclick = closeForm;
        els.formBackdrop.onclick = closeForm;
        els.btnSave.onclick = saveJournal;

        // --- Manual Trigger for Libraries loaded via defer ---
        window.onload = function() {
            if (typeof gapi !== 'undefined') gapiLoaded();
            if (typeof google !== 'undefined') gisLoaded();
        };
    </script>
</body>
</html>