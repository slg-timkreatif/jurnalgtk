<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jurnal Guru Mandiri</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a73e8', // Google Blue
                        onPrimary: '#ffffff',
                        primaryContainer: '#d2e3fc',
                        onPrimaryContainer: '#001d35',
                        surface: '#ffffff',
                        surfaceVariant: '#f1f3f4',
                        onSurface: '#202124',
                        error: '#d93025',
                    },
                    fontFamily: { sans: ['Roboto', 'sans-serif'] }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        .hidden-view { display: none !important; }
        .hide-scroll::-webkit-scrollbar { display: none; }
        /* Toast Animation */
        #toast-container { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); z-index: 100; display: flex; flex-col-reverse: column-reverse; gap: 8px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: #323232; color: #f1f3f4; padding: 12px 16px; border-radius: 8px; font-size: 14px; animation: slideUp 0.3s ease-out forwards; pointer-events: auto; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .toast.error { background: #d93025; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-surfaceVariant text-onSurface min-h-screen font-sans selection:bg-primaryContainer selection:text-onPrimaryContainer">

    <div id="toast-container"></div>

    <div id="loading-overlay" class="hidden-view fixed inset-0 bg-white/90 z-[70] flex flex-col items-center justify-center p-6 text-center">
        <div class="w-12 h-12 border-4 border-primaryContainer border-t-primary rounded-full animate-spin mb-4"></div>
        <h3 id="loading-text" class="text-lg font-medium text-primary">Memproses...</h3>
        <p id="loading-sub" class="text-sm text-gray-500 mt-2">Jangan tutup halaman ini</p>
    </div>

    <div id="view-login" class="min-h-screen flex flex-col items-center justify-center p-6 bg-white relative">
        <div class="w-20 h-20 bg-primary/10 rounded-full flex items-center justify-center text-primary mb-6">
            <i data-lucide="book-open" width="40" height="40"></i>
        </div>
        <h1 class="text-2xl font-bold mb-2 text-center">Jurnal Guru Mandiri</h1>
        <p class="text-gray-500 text-center mb-12 max-w-xs">Data tersimpan aman di Google Drive Anda sendiri.</p>
        
        <button onclick="app.handleAuth()" class="w-full max-w-sm h-14 bg-white border border-gray-300 rounded-full font-medium text-lg shadow hover:shadow-md transition flex items-center justify-center gap-3 active:bg-gray-50">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
            Masuk dengan Google
        </button>
        <p class="text-xs text-gray-400 mt-8 text-center max-w-xs">
            Saat pertama login, jika muncul peringatan "Unverified App", klik <b>Advanced</b> > <b>Go to Jurnal Guru (unsafe)</b>.
        </p>
    </div>

    <div id="view-dashboard" class="hidden-view pb-24 max-w-2xl mx-auto min-h-screen flex flex-col bg-surfaceVariant">
        <div class="bg-white px-4 py-4 sticky top-0 z-10 shadow-sm">
            <div class="flex justify-between items-center mb-4">
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Halo, <span id="user-name">Guru</span></h1>
                    <p class="text-xs text-gray-500" id="user-email">email@gmail.com</p>
                </div>
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-primary/20 overflow-hidden"></div>
            </div>
            
            <div class="flex gap-2">
                <select id="filter-month" onchange="app.fetchData()" class="flex-1 bg-surfaceVariant text-sm px-3 py-2 rounded-lg outline-none font-medium"></select>
                <select id="filter-year" onchange="app.fetchData()" class="w-24 bg-surfaceVariant text-sm px-3 py-2 rounded-lg outline-none font-medium"></select>
            </div>
        </div>

        <div id="dashboard-list" class="p-4 space-y-3"></div>
        
        <div id="empty-state" class="hidden-view flex flex-col items-center justify-center py-12 text-gray-400">
            <i data-lucide="clipboard-list" width="48" height="48" class="mb-2 opacity-50"></i>
            <p class="text-sm">Belum ada jurnal bulan ini</p>
        </div>
    </div>

    <div id="view-form" class="hidden-view fixed inset-0 z-50 bg-white flex flex-col">
        <div class="px-4 py-3 border-b flex items-center gap-3 bg-white sticky top-0 z-10">
            <button onclick="app.navigate('dashboard')" class="p-2 -ml-2 rounded-full hover:bg-gray-100"><i data-lucide="arrow-left"></i></button>
            <h2 class="font-medium text-lg flex-1">Isi Jurnal</h2>
            <button onclick="app.saveJournal()" class="text-primary font-bold text-sm px-3 py-1.5 bg-primaryContainer rounded-full">SIMPAN</button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 pb-20 space-y-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tanggal</label>
                    <input type="date" id="inp-date" class="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-primary outline-none">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mulai</label>
                        <input type="time" id="inp-start" class="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-primary outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Selesai</label>
                        <input type="time" id="inp-end" class="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-primary outline-none">
                    </div>
                </div>
            </div>

            <hr class="border-gray-100">

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Kegiatan</label>
                <textarea id="inp-activity" rows="3" class="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-primary outline-none resize-none" placeholder="Mengajar kelas 6..."></textarea>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Hasil / Output</label>
                <textarea id="inp-result" rows="2" class="w-full p-3 bg-gray-50 rounded-xl border-none focus:ring-2 focus:ring-primary outline-none resize-none" placeholder="Siswa memahami materi..."></textarea>
            </div>

            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-3">Dokumentasi</label>
                <input type="file" id="inp-file" accept="image/*" class="hidden" onchange="app.handleFileSelect(this)">
                
                <div id="upload-placeholder" onclick="document.getElementById('inp-file').click()" class="w-full h-32 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-50 hover:border-primary transition">
                    <i data-lucide="camera" class="mb-2"></i>
                    <span class="text-xs">Ketuk untuk ambil foto</span>
                </div>

                <div id="preview-container" class="hidden-view relative">
                    <img id="img-preview" class="w-full h-48 object-cover rounded-xl shadow-sm bg-gray-100">
                    <button onclick="app.clearFile()" class="absolute top-2 right-2 w-8 h-8 bg-white/80 rounded-full text-red-500 shadow flex items-center justify-center"><i data-lucide="x" width="16"></i></button>
                    <p class="text-xs text-center mt-2 text-green-600 font-medium flex items-center justify-center gap-1"><i data-lucide="check-circle" width="12"></i> Foto siap diupload</p>
                </div>
            </div>
        </div>
    </div>

    <div id="view-profile" class="hidden-view pb-24 max-w-2xl mx-auto min-h-screen flex flex-col bg-white">
        <div class="px-4 py-4 border-b sticky top-0 bg-white">
            <h1 class="text-xl font-bold">Profil & Laporan</h1>
        </div>
        
        <div class="p-6 flex flex-col items-center">
            <div id="profile-pic-lg" class="w-20 h-20 bg-gray-200 rounded-full mb-4 overflow-hidden"></div>
            <h2 id="profile-name-lg" class="text-lg font-bold">Nama User</h2>
            <p class="text-gray-500 text-sm">Status: Terhubung ke Google Drive</p>
        </div>

        <div class="px-4 space-y-4">
            <div class="bg-surfaceVariant p-4 rounded-2xl">
                <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2"><i data-lucide="user-cog" width="16"></i> Data Sekolah</h3>
                <div class="space-y-3">
                    <input type="text" id="conf-nip" placeholder="NIP Anda" class="w-full px-3 py-2 rounded-lg text-sm border-none focus:ring-2 focus:ring-primary" onchange="localStorage.setItem('jg_nip', this.value)">
                    <input type="text" id="conf-unit" placeholder="Unit Kerja (SD N ...)" class="w-full px-3 py-2 rounded-lg text-sm border-none focus:ring-2 focus:ring-primary" onchange="localStorage.setItem('jg_unit', this.value)">
                    <input type="text" id="conf-ks" placeholder="Nama Kepala Sekolah" class="w-full px-3 py-2 rounded-lg text-sm border-none focus:ring-2 focus:ring-primary" onchange="localStorage.setItem('jg_ks', this.value)">
                    <input type="text" id="conf-nip-ks" placeholder="NIP Kepala Sekolah" class="w-full px-3 py-2 rounded-lg text-sm border-none focus:ring-2 focus:ring-primary" onchange="localStorage.setItem('jg_nip_ks', this.value)">
                </div>
            </div>

            <div class="border rounded-2xl p-4">
                <h3 class="text-sm font-bold text-gray-700 mb-3">Cetak Laporan Bulanan</h3>
                <p class="text-xs text-gray-500 mb-3">Laporan .xlsx dengan Link Bukti Foto (Format Dinas)</p>
                <button onclick="app.downloadExcel()" class="w-full py-3 bg-green-600 text-white rounded-xl font-medium shadow hover:bg-green-700 flex items-center justify-center gap-2">
                    <i data-lucide="sheet"></i> Download Excel
                </button>
            </div>

            <button onclick="app.handleSignOut()" class="w-full py-3 text-red-600 font-medium bg-red-50 rounded-xl mt-4">Keluar Akun</button>
        </div>
    </div>

    <nav id="bottom-nav" class="hidden-view fixed bottom-0 left-0 right-0 h-20 bg-white border-t flex justify-around items-center z-40 max-w-2xl mx-auto pb-2">
        <button onclick="app.navigate('dashboard')" class="nav-item p-2 flex flex-col items-center gap-1 text-gray-500 w-16" data-target="dashboard">
            <i data-lucide="home"></i> <span class="text-[10px] font-medium">Jurnal</span>
        </button>
        
        <button onclick="app.openForm()" class="mb-8 w-14 h-14 bg-primary text-white rounded-2xl shadow-lg shadow-primary/30 flex items-center justify-center transform active:scale-95 transition">
            <i data-lucide="plus" width="28" height="28"></i>
        </button>
        
        <button onclick="app.navigate('profile')" class="nav-item p-2 flex flex-col items-center gap-1 text-gray-500 w-16" data-target="profile">
            <i data-lucide="user"></i> <span class="text-[10px] font-medium">Profil</span>
        </button>
    </nav>

    <script>
        // --- KONFIGURASI CLIENT ID BAPAK ---
        const CLIENT_ID = '283173141538-keji60evn4b4qhn0ngjvcq90n0eanoma.apps.googleusercontent.com'; // Pastikan ini sesuai dengan ID di Google Cloud Console
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';
        
        // Nama File/Folder di Drive User
        const DB_FILENAME = 'JurnalGuru_Database'; 
        const FOLDER_NAME = 'JurnalGuru_Foto';

        const app = {
            tokenClient: null,
            accessToken: null,
            user: null,
            files: { dbId: null, folderId: null },
            data: [],
            isGapiLoaded: false, // Penanda Status Mesin GAPI
            
            init: function() {
                this.initDateFilters();
                
                // Load config lokal
                ['nip','unit','ks','nip_ks'].forEach(k => {
                    const el = document.getElementById('conf-'+k);
                    if(el) el.value = localStorage.getItem('jg_'+k) || '';
                });

                // 1. Siapkan Tombol Login (Identity Services)
                this.tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: (resp) => this.handleTokenResponse(resp),
                });

                // 2. Siapkan Mesin Data (GAPI Client) - FIXED LOGIC
                // Kita load gapi.client dulu sebelum dipanggil di manapun
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            // Kita hanya butuh discoveryDocs karena Auth pakai TokenClient (GIS)
                            discoveryDocs: [
                                "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
                                "https://sheets.googleapis.com/$discovery/rest?version=v4"
                            ],
                        });
                        this.isGapiLoaded = true;
                        console.log("Mesin Google API (GAPI) Siap!");
                    } catch (err) {
                        console.error("Gagal Init GAPI:", err);
                        // Jangan alert dulu, biarkan user coba login, nanti error di handleAuth
                    }
                });

                // Cek sesi tersimpan
                const savedToken = sessionStorage.getItem('g_token');
                if(savedToken) {
                    this.accessToken = savedToken;
                    // Tunggu sebentar sampai GAPI siap, baru load
                    // Menggunakan polling sederhana
                    const checkGapi = setInterval(() => {
                        if(this.isGapiLoaded) {
                            clearInterval(checkGapi);
                            this.loadApp();
                        }
                    }, 500);
                    
                    // Timeout jika GAPI macet (5 detik)
                    setTimeout(() => {
                        if(!this.isGapiLoaded) {
                            clearInterval(checkGapi);
                            console.warn("GAPI timeout, user perlu login ulang manual.");
                        }
                    }, 5000);
                }

                lucide.createIcons();
            },

            // --- AUTHENTICATION ---
            handleAuth: function() {
                // Pastikan mesin GAPI sudah nyala dulu
                if(!this.isGapiLoaded) {
                    alert("Sistem Google sedang disiapkan... Mohon tunggu 3 detik lalu klik lagi.");
                    return;
                }
                
                if (this.accessToken) return this.loadApp();
                this.tokenClient.requestAccessToken();
            },

            handleTokenResponse: async function(resp) {
                if (resp.error) return alert("Login Gagal: " + resp.error);
                this.accessToken = resp.access_token;
                sessionStorage.setItem('g_token', this.accessToken);
                this.loadApp();
            },

            handleSignOut: function() {
                const revokeToken = () => {
                    if(google && google.accounts && google.accounts.oauth2) {
                        google.accounts.oauth2.revoke(this.accessToken, () => { console.log('Revoked'); });
                    }
                };
                if(this.accessToken) revokeToken();
                sessionStorage.clear();
                localStorage.removeItem('jg_files'); 
                location.reload();
            },

            // --- DRIVE & SHEET LOGIC ---
            loadApp: async function() {
                this.showLoading(true, "Menghubungkan ke Drive...");
                document.getElementById('view-login').classList.add('hidden-view');
                
                try {
                    // 1. Load Profile
                    await this.loadUserProfile();
                    
                    // 2. Cek/Buat File Database & Folder
                    await this.ensureDriveFiles();
                    
                    // 3. Masuk Dashboard
                    this.navigate('dashboard');
                    this.fetchData();

                } catch (err) {
                    console.error("Error di loadApp:", err);
                    
                    // Error Handling yang lebih Informatif
                    let msg = "Terjadi kesalahan.";
                    if (err.result && err.result.error && err.result.error.message) {
                        msg = err.result.error.message;
                    } else if (err.message) {
                        msg = err.message;
                    } else {
                        msg = JSON.stringify(err);
                    }
                    
                    if(err.status === 401 || err.status === 403 || msg.includes("UNAUTHENTICATED")) {
                        alert("Sesi Google berakhir. Silakan login ulang.");
                        this.handleSignOut();
                    } else {
                        alert("Gagal memuat data:\n" + msg);
                        document.getElementById('view-login').classList.remove('hidden-view');
                    }
                }
                this.showLoading(false);
            },

            loadUserProfile: async function() {
                const res = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${this.accessToken}` }
                }).then(r => r.json());
                
                if(res.error) throw new Error(res.error_description || "Gagal ambil profil");

                this.user = res;
                document.getElementById('user-name').innerText = res.given_name || "Guru";
                document.getElementById('user-email').innerText = res.email;
                document.getElementById('profile-name-lg').innerText = res.name;
                
                const ava = `<img src="${res.picture}" class="w-full h-full object-cover">`;
                document.getElementById('user-avatar').innerHTML = ava;
                document.getElementById('profile-pic-lg').innerHTML = ava;
            },

            ensureDriveFiles: async function() {
                const cached = JSON.parse(localStorage.getItem('jg_files'));
                // Validasi cache sederhana
                if (cached && cached.dbId && cached.folderId) {
                    this.files = cached;
                    return;
                }

                this.setLoadingText("Mengecek Database...");
                
                // Cari Database (Gunakan gapi.client.drive)
                const q = `name = '${DB_FILENAME}' and mimeType = 'application/vnd.google-apps.spreadsheet' and trashed = false`;
                const resDb = await gapi.client.drive.files.list({ q: q });

                if (resDb.result.files.length > 0) {
                    this.files.dbId = resDb.result.files[0].id;
                } else {
                    this.setLoadingText("Membuat Database Baru...");
                    const createDb = await gapi.client.drive.files.create({
                        resource: { name: DB_FILENAME, mimeType: 'application/vnd.google-apps.spreadsheet' }
                    });
                    this.files.dbId = createDb.result.id;
                    
                    // Setup Header Sheet
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: this.files.dbId,
                        range: 'Sheet1!A1:G1',
                        valueInputOption: 'RAW',
                        resource: { values: [['Tanggal', 'Jam Mulai', 'Jam Selesai', 'Kegiatan', 'Hasil', 'ID Foto', 'Link Foto']] }
                    });
                }

                // Cari Folder
                const qF = `name = '${FOLDER_NAME}' and mimeType = 'application/vnd.google-apps.folder' and trashed = false`;
                const resF = await gapi.client.drive.files.list({ q: qF });

                if (resF.result.files.length > 0) {
                    this.files.folderId = resF.result.files[0].id;
                } else {
                    this.setLoadingText("Membuat Folder Foto...");
                    const createF = await gapi.client.drive.files.create({
                        resource: { name: FOLDER_NAME, mimeType: 'application/vnd.google-apps.folder' }
                    });
                    this.files.folderId = createF.result.id;
                }

                localStorage.setItem('jg_files', JSON.stringify(this.files));
            },

            fetchData: async function() {
                this.showLoading(true, "Memuat Data...");
                try {
                    const res = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: this.files.dbId,
                        range: 'Sheet1!A2:G1000', 
                    });
                    
                    const rows = res.result.values || [];
                    this.data = rows.map(r => ({
                        tanggal: r[0], mulai: r[1], selesai: r[2],
                        kegiatan: r[3], hasil: r[4], fotoId: r[5], fotoLink: r[6]
                    })).reverse(); 

                    this.renderList();
                } catch(e) { 
                    console.error("Fetch error:", e); 
                    // Optional: Handle error fetch silent
                }
                this.showLoading(false);
            },

            renderList: function() {
                const m = document.getElementById('filter-month').value;
                const y = document.getElementById('filter-year').value;
                const container = document.getElementById('dashboard-list');
                const empty = document.getElementById('empty-state');
                
                container.innerHTML = '';
                
                const filtered = this.data.filter(item => {
                    if(!item.tanggal) return false;
                    const d = new Date(item.tanggal);
                    return (d.getMonth() + 1) == m && d.getFullYear() == y;
                });

                if(filtered.length === 0) {
                    empty.classList.remove('hidden-view');
                } else {
                    empty.classList.add('hidden-view');
                    filtered.forEach(item => {
                        const hasFoto = item.fotoLink && item.fotoLink.startsWith('http');
                        const card = document.createElement('div');
                        card.className = "bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex flex-col gap-2";
                        
                        const dateObj = new Date(item.tanggal);
                        
                        card.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="bg-primary/10 text-primary px-2 py-1 rounded-md text-xs font-bold text-center w-14">
                                    <div class="text-[10px] uppercase">${dateObj.toLocaleDateString('id-ID', {weekday:'short'})}</div>
                                    <div class="text-lg">${dateObj.getDate()}</div>
                                </div>
                                <div class="flex-1 ml-3">
                                    <h3 class="font-medium text-gray-800 line-clamp-1">${item.kegiatan}</h3>
                                    <p class="text-xs text-gray-500 line-clamp-2 mt-1">${item.hasil}</p>
                                    <div class="flex items-center gap-3 mt-2">
                                        <span class="text-[10px] bg-gray-100 px-2 py-0.5 rounded text-gray-500 flex items-center gap-1">
                                            <i data-lucide="clock" width="10"></i> ${item.mulai} - ${item.selesai}
                                        </span>
                                        ${hasFoto ? `<a href="${item.fotoLink}" target="_blank" class="text-[10px] text-blue-600 flex items-center gap-1 hover:underline"><i data-lucide="image" width="10"></i> Lihat Foto</a>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    });
                }
                lucide.createIcons();
            },

            fileToUpload: null,

            openForm: function() {
                document.getElementById('inp-date').valueAsDate = new Date();
                document.getElementById('inp-activity').value = "";
                document.getElementById('inp-result').value = "";
                this.clearFile();
                this.navigate('form');
            },

            handleFileSelect: function(input) {
                if (input.files && input.files[0]) {
                    const file = input.files[0];
                    if(file.size > 5*1024*1024) return alert("File max 5MB");
                    this.fileToUpload = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('img-preview').src = e.target.result;
                        document.getElementById('preview-container').classList.remove('hidden-view');
                        document.getElementById('upload-placeholder').classList.add('hidden-view');
                    };
                    reader.readAsDataURL(file);
                }
            },

            clearFile: function() {
                this.fileToUpload = null;
                document.getElementById('inp-file').value = "";
                document.getElementById('preview-container').classList.add('hidden-view');
                document.getElementById('upload-placeholder').classList.remove('hidden-view');
            },

            saveJournal: async function() {
                const form = {
                    date: document.getElementById('inp-date').value,
                    start: document.getElementById('inp-start').value,
                    end: document.getElementById('inp-end').value,
                    act: document.getElementById('inp-activity').value,
                    res: document.getElementById('inp-result').value
                };

                if(!form.date || !form.act) return alert("Mohon lengkapi tanggal dan kegiatan.");

                this.showLoading(true, "Mengupload Data...");
                let fotoId = "", fotoLink = "";

                try {
                    // Upload Foto pakai API Multipart (Lebih stabil)
                    if (this.fileToUpload) {
                        this.setLoadingText("Mengupload Foto ke Drive...");
                        const metadata = {
                            name: `Jurnal_${form.date}_${Date.now()}.jpg`,
                            parents: [this.files.folderId]
                        };
                        
                        const formData = new FormData();
                        formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                        formData.append('file', this.fileToUpload);

                        const resUpload = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,webViewLink', {
                            method: 'POST',
                            headers: new Headers({'Authorization': 'Bearer ' + this.accessToken}),
                            body: formData
                        }).then(r => r.json());

                        if(resUpload.error) throw new Error(resUpload.error.message);
                        
                        fotoId = resUpload.id;
                        fotoLink = resUpload.webViewLink;
                    }

                    this.setLoadingText("Menyimpan ke Excel...");
                    const rowData = [form.date, form.start, form.end, form.act, form.res, fotoId, fotoLink];
                    
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: this.files.dbId,
                        range: 'Sheet1!A:G',
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [rowData] }
                    });

                    this.showToast("Jurnal berhasil disimpan!");
                    this.fetchData();
                    this.navigate('dashboard');

                } catch (e) {
                    console.error(e);
                    alert("Gagal menyimpan: " + (e.message || JSON.stringify(e)));
                }
                this.showLoading(false);
            },

            downloadExcel: function() {
                const m = document.getElementById('filter-month').value;
                const y = document.getElementById('filter-year').value;
                
                const reportData = this.data.filter(item => {
                    const d = new Date(item.tanggal);
                    return (d.getMonth() + 1) == m && d.getFullYear() == y;
                }).reverse();

                if (reportData.length === 0) return alert("Tidak ada data bulan ini.");

                const nip = localStorage.getItem('jg_nip') || '-';
                const unit = localStorage.getItem('jg_unit') || '-';
                const nama = this.user.name;

                const tableData = reportData.map((d, i) => ({
                    "No": i + 1,
                    "Hari/Tanggal": d.tanggal, 
                    "Waktu": `${d.mulai} - ${d.selesai}`,
                    "Uraian Kegiatan": d.kegiatan,
                    "Hasil / Output": d.hasil,
                    "Link Bukti": { t: 's', v: 'Buka Foto', l: { Target: d.fotoLink || '#' } } 
                }));

                const ws = XLSX.utils.json_to_sheet(tableData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Laporan Jurnal");

                const months = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agt", "Sep", "Okt", "Nov", "Des"];
                const filename = `Laporan_Jurnal_${months[m-1]}_${y}_${nama.split(' ')[0]}.xlsx`;

                XLSX.writeFile(wb, filename);
            },

            navigate: function(viewId) {
                ['login','dashboard','form','profile'].forEach(v => {
                    document.getElementById('view-'+v).classList.add('hidden-view');
                });
                document.getElementById('view-'+viewId).classList.remove('hidden-view');
                
                const nav = document.getElementById('bottom-nav');
                if(viewId === 'login' || viewId === 'form') nav.classList.add('hidden-view');
                else {
                    nav.classList.remove('hidden-view');
                    this.updateNav(viewId);
                }
            },
            
            updateNav: function(activeId) {
                document.querySelectorAll('.nav-item').forEach(el => {
                    if(el.dataset.target === activeId) el.classList.add('text-primary');
                    else el.classList.remove('text-primary');
                });
            },

            initDateFilters: function() {
                const mSel = document.getElementById('filter-month');
                const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
                months.forEach((m, i) => {
                    const opt = document.createElement('option');
                    opt.value = i+1; opt.text = m;
                    if(i === new Date().getMonth()) opt.selected = true;
                    mSel.appendChild(opt);
                });
                
                const ySel = document.getElementById('filter-year');
                const currY = new Date().getFullYear();
                [currY, currY-1].forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y; opt.text = y;
                    ySel.appendChild(opt);
                });
            },

            showLoading: function(show, text="Memproses...") {
                const el = document.getElementById('loading-overlay');
                document.getElementById('loading-text').innerText = text;
                if(show) el.classList.remove('hidden-view');
                else el.classList.add('hidden-view');
            },
            
            setLoadingText: function(text) {
                document.getElementById('loading-text').innerText = text;
            },

            showToast: function(msg) {
                const t = document.createElement('div');
                t.className = 'toast';
                t.innerText = msg;
                document.getElementById('toast-container').appendChild(t);
                setTimeout(() => t.remove(), 3000);
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
