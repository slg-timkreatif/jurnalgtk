<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Jurnal GTK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #0f172a; overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.98); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .tab-active { background: #0f172a; color: white; border-color: #0f172a; }
        .tab-inactive { background: white; color: #64748b; border-color: #e2e8f0; }
        .blob { position: absolute; filter: blur(80px); opacity: 0.4; z-index: -1; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800 bg-slate-50">

    <script>
        // MASUKKAN URL TERBARU
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxbM1rg16AfiadnhG5X3FAqXAmiRKxgdjuFbOd4XKUNfDLOIf8V56hEAqehV-xrCFyU/exec"; 
    </script>
    
    <div class="blob bg-blue-600 w-96 h-96 rounded-full top-0 left-0 fixed"></div>
    <div class="blob bg-purple-600 w-96 h-96 rounded-full bottom-0 right-0 fixed"></div>

    <nav class="glass sticky top-0 z-50 px-4 md:px-8 py-3 shadow-sm flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-gradient-to-br from-blue-600 to-purple-600 text-white w-10 h-10 rounded-lg flex items-center justify-center shadow-md"><i class="fas fa-database"></i></div>
            <div><h1 class="text-base font-bold text-slate-900 leading-tight">DATABASE GTK</h1><p class="text-[10px] text-slate-500 font-bold tracking-wider">SISTEM KINERJA</p></div>
        </div>
        <button id="navProfile" onclick="confirmLogout()" class="hidden flex items-center gap-3 bg-slate-100 hover:bg-red-50 hover:border-red-200 transition rounded-full pl-2 pr-4 py-1.5 border border-slate-200 group">
            <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white text-xs group-hover:from-red-500 group-hover:to-red-600"><i class="fas fa-user group-hover:hidden"></i><i class="fas fa-power-off hidden group-hover:block"></i></div>
            <div class="text-right leading-none"><p class="text-sm font-bold text-slate-800 group-hover:text-red-600 transition" id="navName">...</p><p class="text-[10px] text-slate-500 font-medium group-hover:text-red-400" id="navRole">...</p></div>
        </button>
    </nav>

    <main class="max-w-6xl mx-auto p-4 py-6 relative">
        <section id="loginPage" class="max-w-md mx-auto mt-16 fade-in">
            <div class="bg-white/90 backdrop-blur-xl rounded-3xl p-8 shadow-2xl border-t-4 border-blue-600">
                <h2 class="text-2xl font-bold text-center mb-6 text-slate-800">Login Sistem</h2>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <input type="email" id="email" class="w-full px-4 py-3 rounded-xl border bg-slate-50 outline-none" placeholder="Email" required>
                    <input type="password" id="pin" class="w-full px-4 py-3 rounded-xl border bg-slate-50 outline-none" placeholder="PIN" required>
                    <button type="submit" id="btnLogin" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:scale-[1.02] transition shadow-lg">Masuk Dashboard</button>
                </form>
            </div>
        </section>

        <section id="dashboardPage" class="hidden space-y-6 fade-in">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100"><p class="text-xs text-slate-500 font-bold uppercase">Unit Kerja</p><p class="text-sm font-bold text-slate-800 truncate" id="userUnit">...</p></div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100"><p class="text-xs text-slate-500 font-bold uppercase">NIP</p><p class="text-sm font-bold text-slate-800 truncate" id="userNip">...</p></div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100"><p class="text-xs text-slate-500 font-bold uppercase">Kegiatan Bulan Ini</p><p class="text-lg font-bold text-blue-600" id="statMonth">0</p></div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100"><p class="text-xs text-slate-500 font-bold uppercase">Status Database</p><span class="text-xs font-bold px-2 py-0.5 rounded bg-green-100 text-green-700">Aktif</span></div>
            </div>

            <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide" id="menuTabs">
                <button onclick="switchTab('upload')" id="tab-upload" class="tab-active px-5 py-2.5 rounded-xl font-bold shadow-sm transition whitespace-nowrap text-sm"><i class="fas fa-upload mr-2"></i> Setor Jurnal</button>
                <button onclick="loadJournalData()" id="tab-data" class="tab-inactive px-5 py-2.5 rounded-xl font-bold shadow-sm transition whitespace-nowrap text-sm"><i class="fas fa-table mr-2"></i> Data Saya</button>
                <button onclick="switchTab('report')" id="tab-report" class="tab-inactive px-5 py-2.5 rounded-xl font-bold shadow-sm transition whitespace-nowrap text-sm"><i class="fas fa-print mr-2"></i> Laporan</button>
                <button onclick="loadSchoolData()" id="tab-monitoring" class="hidden bg-indigo-50 text-indigo-700 border border-indigo-200 px-5 py-2.5 rounded-xl font-bold shadow-sm transition whitespace-nowrap text-sm"><i class="fas fa-users-cog mr-2"></i> <span id="lblMonitoring">Monitoring</span></button>
            </div>

            <div id="view-upload" class="view-section">
                <div class="bg-white rounded-3xl p-8 border border-slate-200 shadow-lg">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Upload Jurnal Harian</h3>
                    <div id="dropzone" class="border-2 border-dashed border-slate-300 rounded-2xl p-10 text-center cursor-pointer hover:bg-slate-50 transition relative group">
                        <input type="file" id="fileInput" accept=".xlsx" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" onchange="previewFile()">
                        <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition"><i class="fas fa-cloud-upload-alt text-3xl text-blue-500"></i></div>
                        <p class="font-bold text-slate-700">Klik untuk memilih file</p>
                    </div>
                    <div id="filePreview" class="hidden mt-4 bg-slate-50 border border-slate-200 p-4 rounded-xl flex justify-between items-center"><div class="flex items-center gap-3"><i class="fas fa-file-excel text-green-600 text-2xl"></i><div><p class="font-bold text-sm text-slate-700" id="fileName">...</p><p class="text-xs text-slate-400" id="fileSize">...</p></div></div><button onclick="clearFile()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times-circle text-xl"></i></button></div>
                    <button onclick="handleUpload()" id="btnUpload" disabled class="mt-6 w-full bg-slate-200 text-slate-400 py-3 rounded-xl font-bold transition cursor-not-allowed">Kirim Data</button>
                </div>
            </div>

            <div id="view-data" class="view-section hidden">
                <div class="bg-white rounded-3xl p-6 border border-slate-200 shadow-lg min-h-[500px] flex flex-col">
                    <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold">Riwayat Jurnal</h3><div class="flex gap-2"><select id="filterMonth" onchange="applyFilter()" class="bg-slate-50 border text-sm rounded-lg p-2 font-bold outline-none"><option value="all">Semua</option><option value="Jan">Januari</option><option value="Feb">Februari</option><option value="Mar">Maret</option></select><button onclick="loadJournalData()" class="bg-slate-100 hover:bg-slate-200 px-3 py-2 rounded-lg text-sm"><i class="fas fa-sync-alt"></i></button></div></div>
                    <div class="flex-1 overflow-x-auto rounded-xl border border-slate-200 mb-4"><table class="w-full text-sm text-left"><thead class="bg-slate-50 text-slate-700 uppercase font-bold text-xs sticky top-0 z-10"><tr><th class="px-4 py-3 min-w-[120px]">Tanggal</th><th class="px-4 py-3 w-24">Waktu</th><th class="px-4 py-3 min-w-[200px]">Kegiatan</th><th class="px-4 py-3 min-w-[150px]">Hasil</th><th class="px-4 py-3 w-24 text-center">Bukti</th></tr></thead><tbody id="journalTableBody" class="divide-y bg-white text-slate-700"></tbody></table></div>
                    <div class="flex justify-between items-center border-t pt-4"><span class="text-xs text-slate-500 font-bold" id="pageInfo">...</span><div class="flex gap-2"><button onclick="prevPage()" id="btnPrev" class="px-3 py-1 text-xs font-bold bg-slate-100 rounded">Prev</button><button onclick="nextPage()" id="btnNext" class="px-3 py-1 text-xs font-bold bg-slate-100 rounded">Next</button></div></div>
                </div>
            </div>

            <div id="view-report" class="view-section hidden">
                <div class="bg-white rounded-3xl p-8 border border-slate-200 shadow-lg"><h3 class="text-lg font-bold mb-6">Download Laporan</h3><div class="space-y-4"><div><label class="text-xs font-bold text-slate-500 uppercase">Jenis</label><select id="repType" onchange="toggleMonthSelect()" class="w-full p-3 rounded-xl border bg-slate-50 font-bold outline-none"><option value="bulanan">Bulanan</option><option value="semester1">Semester 1</option><option value="semester2">Semester 2</option><option value="tahunan">Tahunan</option></select></div><div class="flex gap-3" id="monthContainer"><div class="flex-1"><label class="text-xs font-bold text-slate-500 uppercase">Bulan</label><select id="repMonth" class="w-full p-3 rounded-xl border bg-slate-50 font-bold outline-none"><option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option></select></div><div class="w-1/3"><label class="text-xs font-bold text-slate-500 uppercase">Tahun</label><select id="repYear" class="w-full p-3 rounded-xl border bg-slate-50 font-bold outline-none"><option value="2025">2025</option><option value="2026">2026</option></select></div></div></div><button onclick="downloadReport()" id="btnDownload" class="mt-6 w-full bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-purple-700 hover:scale-[1.02] transition"><i class="fas fa-file-excel mr-2"></i> Download XLSX</button></div>
            </div>

            <div id="view-monitoring" class="view-section hidden">
                <div class="bg-white rounded-3xl p-6 border border-slate-200 shadow-lg">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-3">
                        <h3 class="text-lg font-bold" id="titleMonitoring">Monitoring</h3>
                        
                        <div id="adminControls" class="hidden flex flex-col md:flex-row gap-2 w-full md:w-auto">
                            <select id="filterUnitAdmin" onchange="loadSchoolData()" class="px-3 py-2 bg-slate-50 border rounded-lg text-sm outline-none font-bold">
                                <option value="all">Semua Sekolah</option>
                            </select>
                            
                            <div class="relative w-full md:w-56">
                                <input type="text" id="searchInput" onkeyup="filterTeachers()" placeholder="Cari Nama Guru..." class="w-full pl-8 pr-4 py-2 bg-slate-50 border rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500">
                                <i class="fas fa-search absolute left-3 top-2.5 text-slate-400 text-xs"></i>
                            </div>
                        </div>
                    </div>
                    <div id="ksListArea" class="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-[600px] overflow-y-auto pr-2"></div>
                </div>
            </div>
        </section>

        <div id="modalKS" class="fixed inset-0 bg-black/50 hidden z-[60] flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[80vh] flex flex-col shadow-2xl">
                <div class="p-4 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl"><h3 class="font-bold text-slate-800" id="modalTitle">...</h3><button onclick="closeModal()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button></div>
                <div class="p-0 overflow-y-auto flex-1 bg-slate-50"><table class="w-full text-sm text-left"><thead class="bg-slate-100 text-xs uppercase font-bold text-slate-600 sticky top-0"><tr><th class="p-3">Tanggal</th><th class="p-3">Kegiatan</th></tr></thead><tbody id="modalBody" class="bg-white divide-y"></tbody></table></div>
            </div>
        </div>
    </main>

    <script>
        let currentUser = null, allJournalData = [], filteredJournalData = [], currentPage = 1, allTeachers = [];
        const ITEMS_PER_PAGE = 10;

        window.onload = () => {
            const saved = localStorage.getItem("gtk_v7_ent");
            if (saved) { currentUser = JSON.parse(saved); initApp(); }
            document.getElementById("repMonth").value = String(new Date().getMonth() + 1).padStart(2, '0');
        };

        function initApp() {
            document.getElementById("loginPage").classList.add("hidden");
            document.getElementById("dashboardPage").classList.remove("hidden");
            document.getElementById("navProfile").classList.remove("hidden");
            document.getElementById("navName").innerText = currentUser.user.nama.split(" ")[0];
            document.getElementById("navRole").innerText = currentUser.user.role;
            document.getElementById("userUnit").innerText = currentUser.user.unit;
            document.getElementById("userNip").innerText = currentUser.user.nip || "-";
            document.getElementById("statMonth").innerText = currentUser.stats.thisMonth;

            // ROLE HANDLING
            if(currentUser.user.role === "Kepala Sekolah" || currentUser.user.role === "Admin") {
                document.getElementById("tab-monitoring").classList.remove("hidden");
                
                if(currentUser.user.role === "Admin") {
                    document.getElementById("lblMonitoring").innerText = "Global Admin";
                    document.getElementById("titleMonitoring").innerText = "Data Guru se-Kabupaten";
                    document.getElementById("adminControls").classList.remove("hidden");
                    loadSchoolList(); // Load Dropdown
                }
            }
        }

        async function handleLogin(e) {
            e.preventDefault(); setBtnLoading("btnLogin", true);
            try {
                const res = await fetchAPI({ action: "login", email: document.getElementById("email").value, pin: document.getElementById("pin").value });
                if (res.status === "success") { currentUser = res; localStorage.setItem("gtk_v7_ent", JSON.stringify(res)); initApp(); } 
                else Swal.fire("Login Gagal", res.message, "error");
            } catch (err) { Swal.fire("Error", "Koneksi Bermasalah", "error"); }
            setBtnLoading("btnLogin", false, "Masuk Dashboard");
        }

        function confirmLogout() { Swal.fire({ title: 'Logout?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ya' }).then((r) => { if (r.isConfirmed) { localStorage.removeItem("gtk_v7_ent"); location.reload(); } }); }
        
        function switchTab(name) {
            document.querySelectorAll(".view-section").forEach(el => el.classList.add("hidden"));
            document.getElementById("view-" + name).classList.remove("hidden");
            document.querySelectorAll("#menuTabs button").forEach(b => { b.classList.remove("tab-active"); b.classList.add("tab-inactive"); });
            document.getElementById("tab-" + name).classList.remove("tab-inactive"); document.getElementById("tab-" + name).classList.add("tab-active");
        }

        // --- ADMIN FEATURES ---
        async function loadSchoolList() {
            // Ambil daftar sekolah unik dari backend
            const res = await fetchAPI({ action: "fetch_school_list" });
            if (res.status === "success") {
                const sel = document.getElementById("filterUnitAdmin");
                // Reset (tetap simpan opsi 'Semua')
                sel.innerHTML = '<option value="all">Semua Sekolah</option>';
                res.schools.forEach(s => {
                   if(s) sel.innerHTML += `<option value="${s}">${s}</option>`;
                });
            }
        }

        async function loadSchoolData() {
            switchTab("monitoring");
            const area = document.getElementById("ksListArea"); area.innerHTML = `<div class="col-span-2 text-center p-4"><i class="fas fa-spinner fa-spin"></i> Loading...</div>`;
            
            const filterUnit = document.getElementById("filterUnitAdmin").value;
            
            const res = await fetchAPI({ 
                action: "fetch_school_data", 
                unit: currentUser.user.unit, 
                email: currentUser.user.email, 
                role: currentUser.user.role,
                filterUnit: filterUnit // Kirim filter ke backend
            });
            
            if(res.status==="success") {
                allTeachers = res.teachers;
                renderTeacherList(allTeachers);
            }
        }

        function renderTeacherList(list) {
            const area = document.getElementById("ksListArea");
            if(list.length === 0) { area.innerHTML = `<div class="col-span-2 text-center text-slate-400 p-4">Tidak ada data guru.</div>`; return; }
            
            area.innerHTML = list.map(t => `
                <div class="bg-white border p-4 rounded-xl hover:shadow-md transition flex justify-between items-center group">
                    <div class="overflow-hidden">
                        <h4 class="font-bold text-slate-800 truncate">${t.nama}</h4>
                        <p class="text-[10px] text-slate-500 font-bold uppercase">${t.unit}</p> 
                        <span class="text-[10px] ${t.hasDb?'text-green-600 bg-green-50':'text-red-500 bg-red-50'} px-2 py-0.5 rounded font-bold">${t.hasDb?'DATA ADA':'KOSONG'}</span>
                    </div>
                    <button onclick="inspectGuru('${t.email}','${t.nama}')" class="bg-slate-100 px-3 py-1 rounded text-xs font-bold hover:bg-slate-900 hover:text-white transition">Lihat</button>
                </div>`).join("");
        }

        function filterTeachers() {
            const keyword = document.getElementById("searchInput").value.toLowerCase();
            const filtered = allTeachers.filter(t => t.nama.toLowerCase().includes(keyword));
            renderTeacherList(filtered);
        }

        async function loadJournalData() { switchTab("data"); const b = document.getElementById("journalTableBody"); b.innerHTML = `<tr><td colspan="5" class="p-8 text-center"><i class="fas fa-spinner fa-spin"></i></td></tr>`; const r = await fetchAPI({action:"fetch_journal", dbId:currentUser.user.dbId}); if(r.status==="success"){allJournalData=r.data; applyFilter();} else b.innerHTML="Error"; }
        function applyFilter() { const v = document.getElementById("filterMonth").value; filteredJournalData = v === "all" ? allJournalData : allJournalData.filter(i => i.tgl.includes(v)); currentPage = 1; renderTable(); }
        function renderTable() { 
            const b = document.getElementById("journalTableBody");
            if(filteredJournalData.length===0){b.innerHTML=`<tr><td colspan="5" class="p-8 text-center text-slate-400">Kosong</td></tr>`; return;}
            const start=(currentPage-1)*ITEMS_PER_PAGE;
            b.innerHTML = filteredJournalData.slice(start, start+ITEMS_PER_PAGE).map(r => `<tr class="border-b align-top"><td class="p-3 text-xs font-bold w-24 leading-tight">${r.tgl}</td><td class="p-3 text-xs w-20">${r.waktu||'-'}</td><td class="p-3 text-sm">${r.kegiatan}</td><td class="p-3 text-xs text-slate-500">${r.hasil||'-'}</td><td class="p-3 text-center">${r.dok && r.dok.length>5?`<a href="${r.dok}" target="_blank" class="text-blue-600"><i class="fas fa-link"></i></a>`:'-'}</td></tr>`).join("");
            document.getElementById("pageInfo").innerText = `Hal ${currentPage}/${Math.ceil(filteredJournalData.length/ITEMS_PER_PAGE)}`;
            document.getElementById("btnPrev").disabled = currentPage===1; document.getElementById("btnNext").disabled = currentPage===Math.ceil(filteredJournalData.length/ITEMS_PER_PAGE);
        }
        function prevPage(){if(currentPage>1){currentPage--; renderTable();}} function nextPage(){if(currentPage<Math.ceil(filteredJournalData.length/ITEMS_PER_PAGE)){currentPage++; renderTable();}}
        
        async function inspectGuru(e,n) { document.getElementById("modalKS").classList.remove("hidden"); document.getElementById("modalTitle").innerText = n; document.getElementById("modalBody").innerHTML="Loading..."; const r = await fetchAPI({action:"fetch_journal", targetEmail:e}); document.getElementById("modalBody").innerHTML = r.status==="success" && r.data.length>0 ? r.data.map(d=>`<tr class="border-b"><td class="p-3 text-xs w-24 font-bold">${d.tgl}</td><td class="p-3 text-sm">${d.kegiatan}</td></tr>`).join("") : "Kosong"; }
        function closeModal() { document.getElementById("modalKS").classList.add("hidden"); }
        function previewFile(){const f=document.getElementById("fileInput").files[0]; if(f){document.getElementById("dropzone").classList.add("hidden"); document.getElementById("filePreview").classList.remove("hidden"); document.getElementById("fileName").innerText=f.name; document.getElementById("fileSize").innerText=(f.size/1024).toFixed(1)+" KB"; document.getElementById("btnUpload").disabled=false; document.getElementById("btnUpload").className="mt-6 w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-slate-800 shadow-lg";}}
        function clearFile(){document.getElementById("fileInput").value=""; document.getElementById("dropzone").classList.remove("hidden"); document.getElementById("filePreview").classList.add("hidden"); document.getElementById("btnUpload").disabled=true; document.getElementById("btnUpload").className="mt-6 w-full bg-slate-200 text-slate-400 py-3 rounded-xl font-bold cursor-not-allowed";}
        async function handleUpload(){const f=document.getElementById("fileInput").files[0]; if(!(await Swal.fire({title:'Kirim?',icon:'question',showCancelButton:true})).isConfirmed)return; setBtnLoading("btnUpload",true); const r=new FileReader(); r.onload=async(e)=>{const res=await fetchAPI({action:"upload",email:currentUser.user.email,fileName:f.name,fileData:e.target.result.split(",")[1]}); if(res.status==="success"){Swal.fire("Sukses",res.message,"success");clearFile();}else Swal.fire("Gagal",res.message,"error"); setBtnLoading("btnUpload",false,"Kirim Data");}; r.readAsDataURL(f);}
        function toggleMonthSelect(){document.getElementById("monthContainer").className = document.getElementById("repType").value==="bulanan"?"flex gap-3":"hidden";}
        async function downloadReport(){setBtnLoading("btnDownload",true); try{const r=await fetchAPI({action:"download_report",email:currentUser.user.email,type:document.getElementById("repType").value,month:document.getElementById("repMonth").value,year:document.getElementById("repYear").value}); if(r.status==="success")window.open(r.downloadUrl,"_blank"); else Swal.fire("Gagal",r.message,"warning");}catch(e){Swal.fire("Error","Gagal","error");}setBtnLoading("btnDownload",false,'Download XLSX');}
        async function fetchAPI(d){const r=await fetch(GAS_API_URL,{method:"POST",body:JSON.stringify(d)}); return await r.json();}
        function setBtnLoading(id,l,t=""){const b=document.getElementById(id); if(l){b.disabled=true; b.innerHTML='<i class="fas fa-circle-notch fa-spin"></i>';}else{b.disabled=false; b.innerHTML=t;}}
    </script>
</body>
</html>
