<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Jurnal GTK</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
      if (window.innerWidth <= 800 && !window.location.href.includes('v=mobile')) {
          var sep = window.location.href.includes('?') ? '&' : '?';
          window.location.href = window.location.href + sep + "v=mobile";
      }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .sidebar-active { background-color: #eff6ff; color: #2563eb; border-right: 3px solid #2563eb; }
        .btn-loading { pointer-events: none; opacity: 0.7; }
        
        /* Glass Effect untuk Login */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="text-slate-800">

    <script>
        // --- KONFIGURASI URL ---
        // GANTI DENGAN URL WEB APP ANDA SENDIRI
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxbM1rg16AfiadnhG5X3FAqXAmiRKxgdjuFbOd4XKUNfDLOIf8V56hEAqehV-xrCFyU/exec"; 
    </script>

    <div id="loginPage" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 p-4">
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] rounded-full bg-blue-600/20 blur-3xl"></div>
            <div class="absolute top-[40%] -right-[10%] w-[40%] h-[40%] rounded-full bg-purple-600/20 blur-3xl"></div>
        </div>

        <div class="glass-panel rounded-2xl shadow-2xl w-full max-w-md overflow-hidden fade-in relative z-10">
            <div class="bg-blue-600 p-8 text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full bg-white opacity-10 transform -skew-y-6 scale-150"></div>
                <div class="relative z-10">
                    <div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center mx-auto mb-4 text-blue-600 text-3xl shadow-lg">
                        <i class="fas fa-database"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white">Database Jurnal</h2>
                    <p class="text-blue-100 text-sm mt-1">Sistem Informasi Manajemen Guru</p>
                </div>
            </div>
            
            <form onsubmit="handleLogin(event)" class="p-8 pt-10">
                <div class="mb-5">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Email Dinas</label>
                    <div class="relative">
                        <i class="fas fa-envelope absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="email" id="email" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition" placeholder="nama@sekolah.belajar.id" required>
                    </div>
                </div>
                
                <div class="mb-8">
                    <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">PIN Akses</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="password" id="pin" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm transition" placeholder="••••" required>
                    </div>
                </div>
                
                <button type="submit" id="btnLogin" class="w-full bg-slate-800 text-white py-3.5 rounded-xl font-bold hover:bg-slate-900 transition shadow-lg transform active:scale-95">
                    Masuk Aplikasi
                </button>
            </form>
        </div>
    </div>

    <div id="dashboardPage" class="flex h-screen overflow-hidden hidden">
        
        <aside class="w-64 bg-white border-r border-slate-200 flex flex-col z-20 shadow-sm transition-all duration-300">
            <div class="p-6 flex items-center gap-3 border-b border-slate-100">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-md">
                    <i class="fas fa-database text-xs"></i>
                </div>
                <h1 class="font-bold text-slate-800 text-lg tracking-tight">DB Jurnal</h1>
            </div>

            <div class="p-4 flex-1 overflow-y-auto">
                <div class="bg-blue-50 rounded-xl p-4 border border-blue-100 mb-6 flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-blue-600 font-bold border border-blue-200 text-sm shadow-sm" id="avatarInitial">U</div>
                    <div class="overflow-hidden">
                        <h4 class="font-bold text-slate-800 text-sm truncate" id="userName">User Name</h4>
                        <p class="text-xs text-slate-500 truncate" id="userUnit">Unit Kerja</p>
                    </div>
                </div>

                <nav class="space-y-1">
                    <a onclick="switchTab('upload')" id="nav-upload" class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 rounded-xl hover:bg-slate-50 cursor-pointer transition sidebar-active">
                        <i class="fas fa-cloud-upload-alt w-5"></i> Upload
                    </a>
                    <a onclick="switchTab('data')" id="nav-data" class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 rounded-xl hover:bg-slate-50 cursor-pointer transition">
                        <i class="fas fa-table w-5"></i> Data Jurnal
                    </a>
                    <a onclick="switchTab('report')" id="nav-report" class="flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 rounded-xl hover:bg-slate-50 cursor-pointer transition">
                        <i class="fas fa-file-invoice w-5"></i> Laporan
                    </a>
                    <a onclick="loadMonitoring()" id="nav-monitoring" class="hidden flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-600 rounded-xl hover:bg-slate-50 cursor-pointer transition">
                        <i class="fas fa-users-cog w-5"></i> Monitoring
                    </a>
                </nav>
            </div>

            <div class="p-4 border-t border-slate-100">
                <button onclick="doLogout()" class="flex items-center gap-3 px-4 py-3 w-full text-sm font-medium text-red-600 rounded-xl hover:bg-red-50 transition">
                    <i class="fas fa-sign-out-alt w-5"></i> Keluar
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-slate-50 p-8 relative scroll-smooth">
            
            <div id="view-upload" class="view-section fade-in max-w-4xl mx-auto">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-slate-800">Upload Jurnal</h2>
                    <p class="text-slate-500 text-sm">Upload file Excel kegiatan harian Anda disini.</p>
                </div>

                <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-200 text-center">
                    <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-2xl p-12 bg-slate-50 hover:bg-blue-50 hover:border-blue-400 transition cursor-pointer relative group">
                        <input type="file" id="fileInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept=".xlsx" onchange="handleFileSelect(this)">
                        
                        <div class="pointer-events-none group-hover:scale-105 transition duration-300">
                            <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm text-blue-500 text-4xl border border-blue-50">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <h3 class="font-bold text-slate-700 text-lg">Klik atau Tarik File Excel</h3>
                            <p class="text-slate-400 text-sm mt-1">Format .xlsx (Maks 5MB)</p>
                        </div>
                    </div>

                    <div id="fileInfo" class="hidden mt-6 bg-blue-50 border border-blue-100 p-4 rounded-xl flex items-center justify-between text-left animate-pulse-once">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center text-green-600 shadow-sm text-xl border border-green-100">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-slate-800 text-sm" id="fileName">filename.xlsx</h4>
                                <p class="text-xs text-blue-600 font-medium">Siap diupload</p>
                            </div>
                        </div>
                        <button onclick="resetFile()" class="w-8 h-8 rounded-full bg-white text-slate-400 hover:text-red-500 shadow-sm flex items-center justify-center transition">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <button id="btnUpload" onclick="uploadData()" disabled class="mt-8 w-full bg-slate-200 text-slate-400 py-4 rounded-xl font-bold transition cursor-not-allowed">
                        Kirim Data Sekarang
                    </button>
                </div>
            </div>

            <div id="view-data" class="view-section hidden fade-in max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800">Data Jurnal</h2>
                        <p class="text-slate-500 text-sm">Riwayat kegiatan yang telah tersimpan.</p>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="loadData()" class="bg-white border border-slate-200 text-slate-600 px-4 py-2.5 rounded-xl text-sm font-bold hover:bg-slate-50 transition shadow-sm flex items-center gap-2">
                            <i class="fas fa-sync-alt"></i> Refresh Data
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-5 border-b border-slate-100 bg-slate-50/50 flex flex-col md:flex-row gap-4">
                        <div class="relative flex-1">
                            <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                            <input type="text" id="searchData" onkeyup="filterData()" placeholder="Cari kegiatan..." class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 transition shadow-sm">
                        </div>
                        <div class="flex gap-2">
                            <select id="filterMonth" onchange="filterData()" class="px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer shadow-sm min-w-[150px]">
                                <option value="all">Semua Bulan</option>
                                <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                                <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                                <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                                <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                            </select>
                            <select id="filterYear" onchange="filterData()" class="px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 cursor-pointer shadow-sm">
                                <option value="all">Tahun</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm text-slate-600">
                            <thead class="bg-slate-50 text-slate-700 font-bold uppercase text-xs tracking-wider border-b border-slate-200">
                                <tr>
                                    <th class="p-5 w-40">Tanggal</th>
                                    <th class="p-5 w-32">Waktu</th>
                                    <th class="p-5">Uraian Kegiatan</th>
                                    <th class="p-5 w-24 text-center">Bukti</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-slate-100 bg-white">
                                <tr><td colspan="4" class="p-8 text-center text-slate-400">Memuat data...</td></tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="p-4 border-t border-slate-100 flex items-center justify-between bg-slate-50/50">
                        <p class="text-xs text-slate-500 font-medium" id="pageInfo">Menampilkan 0-0 dari 0 data</p>
                        <div class="flex gap-2">
                            <button onclick="prevPage()" id="btnPrev" disabled class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50 disabled:opacity-50 transition shadow-sm">Prev</button>
                            <button onclick="nextPage()" id="btnNext" disabled class="px-4 py-2 bg-white border border-slate-200 rounded-lg text-xs font-bold text-slate-500 hover:bg-slate-50 disabled:opacity-50 transition shadow-sm">Next</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-report" class="view-section hidden fade-in max-w-2xl mx-auto">
                 <div class="mb-8">
                    <h2 class="text-2xl font-bold text-slate-800">Cetak Laporan</h2>
                    <p class="text-slate-500 text-sm">Download laporan kinerja dalam format Excel.</p>
                </div>

                <div class="bg-white rounded-2xl p-8 shadow-sm border border-slate-200">
                    <div class="mb-6">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Jenis Laporan</label>
                        <div class="relative">
                            <select id="repType" onchange="toggleMonthSelect()" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-green-500 transition appearance-none">
                                <option value="bulanan">Laporan Bulanan</option>
                                <option value="tahunan">Laporan Tahunan (Rekap)</option>
                            </select>
                            <i class="fas fa-chevron-down absolute right-4 top-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <div id="monthContainer" class="flex gap-4 mb-8">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Bulan</label>
                            <div class="relative">
                                <select id="repMonth" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-green-500 transition appearance-none">
                                    <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                                    <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                                    <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                                    <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-4 top-4 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>
                        <div class="w-32">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2 ml-1">Tahun</label>
                            <input type="number" id="repYear" class="w-full p-4 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold text-center outline-none focus:ring-2 focus:ring-green-500 transition" value="2026">
                        </div>
                    </div>

                    <button onclick="downloadReport()" id="btnDownload" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-700 transition flex items-center justify-center gap-2 active:scale-[0.98]">
                        <i class="fas fa-file-excel"></i> Download File Excel
                    </button>
                </div>
            </div>

            <div id="view-monitoring" class="view-section hidden fade-in max-w-5xl mx-auto">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-slate-800">Monitoring Guru</h2>
                    <p class="text-slate-500 text-sm">Status database guru di unit kerja Anda.</p>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <div class="relative mb-6">
                        <i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
                        <input type="text" id="searchGuru" onkeyup="filterTeachers()" placeholder="Cari Nama Guru..." class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 transition">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="ksListArea">
                        <div class="text-center p-12 text-slate-400 col-span-full">
                            <i class="fas fa-circle-notch fa-spin text-2xl mb-2"></i>
                            <p>Memuat data guru...</p>
                        </div>
                    </div>
                </div>
             </div>

        </main>
    </div>

    <script>
        // --- VARIABLES ---
        let currentUser = null;
        let allData = [];
        let filteredData = [];
        let allTeachers = [];
        
        // Pagination Vars
        let currentPage = 1;
        const itemsPerPage = 10;

        // Init
        window.onload = function() {
            const savedUser = localStorage.getItem("gtk_v7_ent");
            if(savedUser) {
                currentUser = JSON.parse(savedUser);
                initDashboard();
            }
            document.getElementById("repMonth").value = String(new Date().getMonth() + 1).padStart(2, '0');
        };

        // --- NAVIGATION ---
        function switchTab(tabId) {
            // 1. Sembunyikan semua view
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            
            // 2. Tampilkan view target
            const target = document.getElementById('view-' + tabId);
            if(target) target.classList.remove('hidden');
            
            // 3. Update Sidebar Active State
            const navIds = ['nav-upload', 'nav-data', 'nav-report', 'nav-monitoring'];
            navIds.forEach(id => {
                const nav = document.getElementById(id);
                if(nav) nav.classList.remove('sidebar-active', 'text-blue-600', 'bg-blue-50');
            });
            
            const activeNav = document.getElementById('nav-' + tabId);
            if(activeNav) activeNav.classList.add('sidebar-active', 'text-blue-600', 'bg-blue-50');

            // 4. KHUSUS TAB DATA: Load data jika belum ada
            if (tabId === 'data' && allData.length === 0) {
                loadData();
            }
        }

        // --- AUTH ---
        async function handleLogin(e) {
            e.preventDefault();
            setBtnLoading("btnLogin", true, '<i class="fas fa-spinner fa-spin"></i> Loading...');
            
            try {
                const res = await fetchAPI({ 
                    action: "login", 
                    email: document.getElementById("email").value, 
                    pin: document.getElementById("pin").value 
                });
                
                if (res.status === "success") {
                    currentUser = res.user;
                    localStorage.setItem("gtk_v7_ent", JSON.stringify(currentUser));
                    initDashboard();
                    Swal.fire({
                        icon: 'success', title: 'Berhasil Masuk',
                        text: `Selamat datang, ${currentUser.nama}`,
                        timer: 1500, showConfirmButton: false
                    });
                } else {
                    Swal.fire("Login Gagal", res.message, "error");
                }
            } catch (err) {
                Swal.fire("Error", "Gagal menghubungi server", "error");
            }
            setBtnLoading("btnLogin", false, 'Masuk Aplikasi');
        }

        function initDashboard() {
            document.getElementById("loginPage").classList.add("hidden");
            document.getElementById("dashboardPage").classList.remove("hidden");
            
            document.getElementById("userName").innerText = currentUser.nama;
            document.getElementById("userUnit").innerText = currentUser.unit;
            document.getElementById("avatarInitial").innerText = currentUser.nama.charAt(0).toUpperCase();

            // Admin Check
            if (currentUser.role === "Kepala Sekolah" || currentUser.role === "Admin") {
                document.getElementById("nav-monitoring").classList.remove("hidden");
            }

            // Default Tab
            switchTab('upload');
        }

        function doLogout() {
            Swal.fire({
                title: 'Keluar Aplikasi?', icon: 'warning',
                showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'Ya, Keluar'
            }).then((result) => {
                if (result.isConfirmed) {
                    localStorage.removeItem("gtk_v7_ent");
                    location.reload();
                }
            });
        }

        // --- API HELPER ---
        async function fetchAPI(data) {
            const response = await fetch(GAS_API_URL, {
                method: "POST",
                body: JSON.stringify(data)
            });
            return await response.json();
        }

        function setBtnLoading(id, isLoading, text) {
            const btn = document.getElementById(id);
            if(isLoading) {
                btn.classList.add("btn-loading");
                btn.innerHTML = text;
            } else {
                btn.classList.remove("btn-loading");
                btn.innerHTML = text;
            }
        }

        // --- UPLOAD LOGIC ---
        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                document.getElementById("dropZone").classList.add("hidden");
                document.getElementById("fileInfo").classList.remove("hidden");
                document.getElementById("fileName").innerText = file.name;
                
                const btn = document.getElementById("btnUpload");
                btn.disabled = false;
                btn.classList.remove("bg-slate-200", "text-slate-400", "cursor-not-allowed");
                btn.classList.add("bg-blue-600", "text-white", "hover:bg-blue-700", "shadow-lg");
            }
        }

        function resetFile() {
            document.getElementById("fileInput").value = "";
            document.getElementById("dropZone").classList.remove("hidden");
            document.getElementById("fileInfo").classList.add("hidden");
            
            const btn = document.getElementById("btnUpload");
            btn.disabled = true;
            btn.classList.add("bg-slate-200", "text-slate-400", "cursor-not-allowed");
            btn.classList.remove("bg-blue-600", "text-white", "hover:bg-blue-700", "shadow-lg");
        }

        async function uploadData() {
            const file = document.getElementById("fileInput").files[0];
            if(!file) return;

            const confirm = await Swal.fire({
                title: 'Kirim Data?', text: "Pastikan format Excel sudah sesuai.", icon: 'question',
                showCancelButton: true, confirmButtonText: 'Ya, Kirim'
            });

            if(confirm.isConfirmed) {
                setBtnLoading("btnUpload", true, "Mengirim Data...");
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64 = e.target.result.split(",")[1];
                    try {
                        const res = await fetchAPI({
                            action: "upload",
                            email: currentUser.email,
                            fileName: file.name,
                            fileData: base64
                        });
                        
                        if (res.status === "success") {
                            Swal.fire("Berhasil", res.message, "success");
                            resetFile();
                            // Reset data agar reload saat buka tab data lagi
                            allData = []; 
                        } else {
                            Swal.fire("Gagal", res.message, "error");
                        }
                    } catch (err) {
                        Swal.fire("Error", "Gagal upload file", "error");
                    }
                    setBtnLoading("btnUpload", false, "Kirim Data Sekarang");
                };
                reader.readAsDataURL(file);
            }
        }

        // --- DATA & PAGINATION (UPDATED SORTING) ---
        async function loadData() {
            // Tampilkan loading di tabel
            const tbody = document.getElementById("tableBody");
            tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center"><i class="fas fa-circle-notch fa-spin text-blue-500 text-2xl"></i><p class="mt-2 text-slate-400">Sedang mengambil data...</p></td></tr>';
            
            const res = await fetchAPI({ action: "fetch_journal", dbId: currentUser.dbId });
            
            if(res.status === "success") {
                allData = res.data;
                
                // SORTING TERBARU: DESCENDING TANGGAL + WAKTU
                allData.sort((a, b) => {
                    // 1. Cek Selisih Tanggal
                    const dateA = parseIndoDate(a.tgl);
                    const dateB = parseIndoDate(b.tgl);
                    const diffDate = dateB - dateA;
                    
                    if (diffDate !== 0) return diffDate; // Jika tanggal beda, urutkan by tanggal
                    
                    // 2. Jika Tanggal Sama, Cek Waktu (Jam)
                    // Normalisasi: ganti titik jadi titik dua (07.00 -> 07:00), hilangkan spasi
                    const timeA = (a.waktu || "00:00").toString().replace('.', ':').trim().padStart(5, '0');
                    const timeB = (b.waktu || "00:00").toString().replace('.', ':').trim().padStart(5, '0');
                    
                    // Compare String Waktu Descending (Siang di atas Pagi)
                    if (timeB > timeA) return 1;
                    if (timeB < timeA) return -1;
                    return 0;
                });
                
                populateYearFilter();
                filterData();
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-red-400">Gagal memuat data</td></tr>';
            }
        }

        function populateYearFilter() {
            const years = new Set(allData.map(d => {
                const parts = d.tgl.split(/[\s/-]/);
                return parts.length >= 3 ? parts[2] : null;
            }).filter(Boolean));
            
            const select = document.getElementById("filterYear");
            select.innerHTML = '<option value="all">Tahun</option>';
            Array.from(years).sort().reverse().forEach(y => {
                select.innerHTML += `<option value="${y}">${y}</option>`;
            });
        }

        function filterData() {
            const search = document.getElementById("searchData").value.toLowerCase();
            const fMonth = document.getElementById("filterMonth").value;
            const fYear = document.getElementById("filterYear").value;

            const monthMap = { "jan":"01", "feb":"02", "mar":"03", "apr":"04", "may":"05", "jun":"06", "jul":"07", "aug":"08", "sep":"09", "oct":"10", "nov":"11", "dec":"12", "mei":"05", "agt":"08", "agu":"08", "okt":"10", "des":"12", "januari":"01", "februari":"02", "maret":"03", "juni":"06", "juli":"07", "agustus":"08", "oktober":"10", "desember":"12" };

            filteredData = allData.filter(item => {
                const parts = item.tgl.split(/[\s/-]/);
                let m = "", y = "";
                if(parts.length >= 3) {
                     m = monthMap[parts[1].toLowerCase()] || parts[1];
                     y = parts[2];
                }
                
                const matchSearch = item.kegiatan.toLowerCase().includes(search);
                const matchMonth = fMonth === "all" || m === fMonth;
                const matchYear = fYear === "all" || y === fYear;

                return matchSearch && matchMonth && matchYear;
            });

            currentPage = 1;
            renderPagination();
        }

        function renderPagination() {
            const tbody = document.getElementById("tableBody");
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            // Render Info
            const total = filteredData.length;
            document.getElementById("pageInfo").innerText = total === 0 ? "Menampilkan 0 data" : `Menampilkan ${start + 1}-${Math.min(end, total)} dari ${total} data`;
            
            // Render Buttons
            document.getElementById("btnPrev").disabled = currentPage === 1;
            document.getElementById("btnNext").disabled = end >= total;

            if(pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-12 text-center text-slate-400 bg-slate-50 rounded-xl"><i class="fas fa-folder-open text-4xl mb-2 opacity-50"></i><p>Data tidak ditemukan</p></td></tr>';
                return;
            }

            let html = "";
            pageData.forEach(row => {
                html += `
                <tr class="border-b border-slate-50 hover:bg-slate-50 transition group">
                    <td class="p-5 font-bold text-blue-600 bg-white group-hover:bg-slate-50 align-top whitespace-nowrap">${row.tgl}</td>
                    <td class="p-5 font-mono text-xs text-slate-500 bg-white group-hover:bg-slate-50 align-top">${row.waktu || '-'}</td>
                    <td class="p-5 bg-white group-hover:bg-slate-50 align-top">
                        <div class="font-bold text-slate-800 mb-1 leading-snug">${row.kegiatan}</div>
                        <div class="text-xs text-slate-500 line-clamp-2">${row.hasil || '-'}</div>
                    </td>
                    <td class="p-5 text-center bg-white group-hover:bg-slate-50 align-top">
                        ${row.dok && row.dok.length > 5 
                            ? `<a href="${row.dok}" target="_blank" class="inline-flex w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white items-center justify-center transition shadow-sm border border-blue-100"><i class="fas fa-link text-xs"></i></a>` 
                            : '<span class="text-slate-300">-</span>'}
                    </td>
                </tr>`;
            });
            tbody.innerHTML = html;
        }

        function prevPage() { if(currentPage > 1) { currentPage--; renderPagination(); } }
        function nextPage() { if((currentPage * itemsPerPage) < filteredData.length) { currentPage++; renderPagination(); } }

        function parseIndoDate(dStr){
            let clean=String(dStr).split(",")[1]||String(dStr); clean=clean.trim(); const parts=clean.split(/[\s/-]+/);
            if(parts.length<3)return new Date();
            const map={'januari':0,'februari':1,'maret':2,'april':3,'mei':4,'juni':5,'juli':6,'agustus':7,'september':8,'oktober':9,'november':10,'desember':11,'jan':0,'feb':1,'mar':2,'apr':3,'jun':5,'jul':6,'agu':7,'sep':8,'okt':9,'nov':10,'des':11};
            return new Date(parseInt(parts[2]), map[parts[1].toLowerCase()]||0, parseInt(parts[0]));
        }

        // --- REPORT ---
        function toggleMonthSelect() {
            const isMonthly = document.getElementById("repType").value === "bulanan";
            document.getElementById("monthContainer").style.display = isMonthly ? "flex" : "none";
        }

        async function downloadReport() {
            setBtnLoading("btnDownload", true, "Generating...");
            try {
                const res = await fetchAPI({
                    action: "download_report",
                    email: currentUser.email,
                    type: document.getElementById("repType").value,
                    month: document.getElementById("repMonth").value,
                    year: document.getElementById("repYear").value
                });
                
                if (res.status === "success") {
                    window.open(res.downloadUrl, "_blank");
                } else {
                    Swal.fire("Gagal", res.message, "warning");
                }
            } catch (err) {
                Swal.fire("Error", "Gagal request laporan", "error");
            }
            setBtnLoading("btnDownload", false, '<i class="fas fa-file-excel"></i> Download File Excel');
        }

        // --- MONITORING (ADMIN) ---
        async function loadMonitoring() {
            switchTab('monitoring');
            const area = document.getElementById("ksListArea");
            area.innerHTML = '<div class="col-span-full text-center p-12 text-slate-400"><i class="fas fa-circle-notch fa-spin text-3xl mb-3"></i><p>Sedang mengambil data guru...</p></div>';
            
            const res = await fetchAPI({ 
                action: "fetch_school_data", unit: currentUser.unit, 
                email: currentUser.email, role: currentUser.role, filterUnit: "all" 
            });

            if(res.status === "success") {
                allTeachers = res.teachers;
                renderTeachers(allTeachers);
            }
        }

        function renderTeachers(list) {
            const area = document.getElementById("ksListArea");
            if(list.length === 0) { area.innerHTML = '<div class="col-span-full text-center p-8 text-slate-400">Data tidak ditemukan</div>'; return; }
            
            area.innerHTML = list.map(t => `
                <div class="bg-white p-5 rounded-2xl border border-slate-200 shadow-sm flex items-center justify-between hover:shadow-md transition group">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 font-bold flex items-center justify-center text-sm group-hover:bg-blue-600 group-hover:text-white transition">
                            ${t.nama.substring(0,2).toUpperCase()}
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-700 text-sm group-hover:text-blue-600 transition">${t.nama}</h4>
                            <p class="text-xs text-slate-400">${t.unit}</p>
                        </div>
                    </div>
                    <span class="px-3 py-1 rounded-lg text-[10px] font-bold tracking-wide ${t.hasDb ? 'bg-green-100 text-green-700' : 'bg-red-50 text-red-500'}">
                        ${t.hasDb ? 'AKTIF' : 'BELUM'}
                    </span>
                </div>
            `).join("");
        }

        function filterTeachers() {
            const key = document.getElementById("searchGuru").value.toLowerCase();
            renderTeachers(allTeachers.filter(t => t.nama.toLowerCase().includes(key)));
        }

    </script>
</body>
</html>
