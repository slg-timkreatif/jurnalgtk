<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jurnal GTK Mobile</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* CSS SAMA DENGAN DESKTOP, DITAMBAH TWEAK MOBILE */
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; padding-bottom: 80px; /* Ruang untuk Bottom Nav */ }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Bottom Navigation Styling */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-top: 1px solid #e2e8f0;
            z-index: 50;
            display: flex; justify-content: space-around;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            padding: 12px 0; width: 100%; text-align: center;
            color: #94a3b8; transition: all 0.2s; position: relative;
        }
        .nav-item.active { color: #2563eb; font-weight: 600; }
        .nav-item.active::after {
            content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 40px; height: 3px; background: #2563eb; border-radius: 0 0 4px 4px;
        }
        
        /* Card List untuk Data (Pengganti Tabel) */
        .journal-card {
            background: white; border-radius: 16px; padding: 16px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid #e2e8f0;
            margin-bottom: 12px; transition: transform 0.1s;
        }
        .journal-card:active { transform: scale(0.98); }
    </style>
</head>
<body class="text-slate-800">

    <script>
        // URL SAMA DENGAN DESKTOP (AKAN DIGANTI OTOMATIS SAAT DEPLOY)
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbxbM1rg16AfiadnhG5X3FAqXAmiRKxgdjuFbOd4XKUNfDLOIf8V56hEAqehV-xrCFyU/exec"; 
    </script>

    <section id="loginPage" class="min-h-screen flex items-center justify-center p-4 bg-slate-900">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-sm fade-in overflow-hidden flex flex-col">
            <div class="bg-blue-600 p-8 text-center">
                <i class="fas fa-database text-5xl text-white mb-4 opacity-90"></i>
                <h2 class="text-2xl font-bold text-white tracking-tight">Database Jurnal</h2>
                <p class="text-blue-100 text-xs mt-1 font-medium">Versi Mobile</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="p-8 space-y-5 flex-1">
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Email Dinas</label>
                    <input type="email" id="email" class="w-full mt-1.5 px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-slate-50" placeholder="nama@sekolah.id" required>
                </div>
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">PIN Akses</label>
                    <input type="password" id="pin" class="w-full mt-1.5 px-4 py-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm bg-slate-50" placeholder="••••••" required>
                </div>
                <button type="submit" id="btnLogin" class="w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold text-sm hover:bg-slate-800 transition shadow-lg">Masuk Aplikasi</button>
            </form>
            <div class="bg-slate-50 p-4 text-center border-t border-slate-100">
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Tim Kreatif Selogiri | 2026</p>
            </div>
        </div>
    </section>

    <div id="dashboardPage" class="hidden">
        
        <header class="bg-white/90 backdrop-blur-md border-b border-slate-200 p-4 sticky top-0 z-40 flex justify-between items-center shadow-sm">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-blue-600 rounded-lg flex items-center justify-center text-white text-sm shadow-blue-200"><i class="fas fa-database"></i></div>
                <div>
                    <h1 class="font-bold text-slate-800 text-sm leading-tight" id="headerName">User</h1>
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wide" id="headerUnit">Unit</p>
                </div>
            </div>
            <button onclick="confirmLogout()" class="w-9 h-9 rounded-full bg-slate-100 text-slate-400 flex items-center justify-center hover:bg-red-50 hover:text-red-500 transition"><i class="fas fa-power-off"></i></button>
        </header>

        <main class="p-4">
            
            <div id="view-upload" class="view-section fade-in">
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6 mb-4">
                    <h2 class="text-lg font-bold text-slate-800 mb-1">Kirim Jurnal</h2>
                    <p class="text-xs text-slate-500 mb-6">Upload file Excel (.xlsx) kegiatan Anda.</p>

                    <div id="dropzone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer bg-slate-50 active:bg-blue-50 active:border-blue-400 transition relative">
                        <input type="file" id="fileInput" accept=".xlsx" class="absolute inset-0 w-full h-full opacity-0 z-10" onchange="previewFile()">
                        <i class="fas fa-cloud-upload-alt text-3xl text-slate-400 mb-3 block"></i>
                        <span class="text-sm font-bold text-slate-600">Pilih File Excel</span>
                    </div>

                    <div id="filePreview" class="hidden mt-4 bg-blue-50 border border-blue-100 p-3 rounded-xl flex items-center justify-between">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center text-green-600 shadow-sm"><i class="fas fa-file-excel"></i></div>
                            <p class="font-bold text-xs text-slate-700 truncate w-32" id="fileName">File.xlsx</p>
                        </div>
                        <button onclick="clearFile()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
                    </div>

                    <button onclick="handleUpload()" id="btnUpload" disabled class="mt-6 w-full py-3 rounded-xl font-bold text-sm bg-slate-200 text-slate-400 transition cursor-not-allowed">Kirim Data</button>
                </div>
            </div>

            <div id="view-data" class="view-section hidden fade-in">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="searchData" onkeyup="applyFilter()" placeholder="Cari kegiatan..." class="w-full px-4 py-2.5 bg-white border border-slate-200 rounded-xl text-sm outline-none shadow-sm focus:ring-2 focus:ring-blue-500">
                    <button onclick="loadJournalData()" class="px-4 bg-white border border-slate-200 rounded-xl text-blue-600 shadow-sm"><i class="fas fa-sync-alt"></i></button>
                </div>
                
                <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
                     <select id="filterMonth" onchange="applyFilter()" class="flex-1 min-w-[120px] px-3 py-2 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 shadow-sm">
                        <option value="all">Semua Bulan</option>
                        <option value="01">Januari</option><option value="02">Februari</option><option value="03">Maret</option>
                        <option value="04">April</option><option value="05">Mei</option><option value="06">Juni</option>
                        <option value="07">Juli</option><option value="08">Agustus</option><option value="09">September</option>
                        <option value="10">Oktober</option><option value="11">November</option><option value="12">Desember</option>
                    </select>
                    <select id="filterYear" onchange="applyFilter()" class="flex-1 min-w-[100px] px-3 py-2 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-600 shadow-sm">
                        <option value="all">Tahun</option>
                    </select>
                </div>

                <div id="journalList" class="pb-4">
                    </div>
            </div>

            <div id="view-report" class="view-section hidden fade-in">
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600"><i class="fas fa-file-invoice"></i></div>
                        <div>
                            <h2 class="font-bold text-slate-800">Cetak Laporan</h2>
                            <p class="text-xs text-slate-500">Format Excel (.xlsx)</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="text-[10px] font-bold text-slate-500 uppercase">Periode</label>
                            <select id="repType" onchange="toggleMonthSelect()" class="w-full mt-1 p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm font-bold">
                                <option value="bulanan">Laporan Bulanan</option>
                                <option value="tahunan">Satu Tahun Penuh</option>
                            </select>
                        </div>
                        <div id="monthContainer" class="flex gap-2">
                            <div class="flex-1">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Bulan</label>
                                <select id="repMonth" class="w-full mt-1 p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm font-bold">
                                    <option value="01">Jan</option><option value="02">Feb</option><option value="03">Mar</option>
                                    <option value="04">Apr</option><option value="05">Mei</option><option value="06">Jun</option>
                                    <option value="07">Jul</option><option value="08">Agu</option><option value="09">Sep</option>
                                    <option value="10">Okt</option><option value="11">Nov</option><option value="12">Des</option>
                                </select>
                            </div>
                            <div class="w-24">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">Tahun</label>
                                <input type="number" id="repYear" class="w-full mt-1 p-3 rounded-xl border border-slate-200 bg-slate-50 text-sm font-bold" value="2026">
                            </div>
                        </div>
                    </div>

                    <button onclick="downloadReport()" id="btnDownload" class="mt-6 w-full bg-slate-900 text-white py-3.5 rounded-xl font-bold text-sm shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> Download
                    </button>
                </div>
            </div>

             <div id="view-monitoring" class="view-section hidden fade-in">
                <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-4 mb-4">
                    <h2 class="font-bold text-indigo-900 text-sm">Monitoring Guru</h2>
                    <p class="text-xs text-indigo-600">Pantau kinerja unit kerja.</p>
                </div>
                
                <input type="text" id="searchGuru" onkeyup="filterTeachers()" placeholder="Cari Nama Guru..." class="w-full mb-4 px-4 py-3 bg-white border border-slate-200 rounded-xl text-sm shadow-sm outline-none">
                
                <div id="ksListArea" class="grid grid-cols-1 gap-3 pb-4"></div>
            </div>

        </main>

        <nav class="bottom-nav">
            <div onclick="switchTab('upload')" id="nav-upload" class="nav-item active">
                <i class="fas fa-paper-plane text-xl mb-1"></i>
                <span class="block text-[10px] font-medium">Kirim</span>
            </div>
            <div onclick="loadJournalData()" id="nav-data" class="nav-item">
                <i class="fas fa-list-alt text-xl mb-1"></i>
                <span class="block text-[10px] font-medium">Data</span>
            </div>
            <div onclick="switchTab('report')" id="nav-report" class="nav-item">
                <i class="fas fa-print text-xl mb-1"></i>
                <span class="block text-[10px] font-medium">Cetak</span>
            </div>
            <div onclick="loadMonitoringData()" id="nav-monitoring" class="nav-item hidden">
                <i class="fas fa-users-cog text-xl mb-1"></i>
                <span class="block text-[10px] font-medium">Monitor</span>
            </div>
        </nav>

    </div>

    <script>
        let currentUser = null, allJournalData = [], filteredJournalData = [], allTeachers = [];

        window.onload = () => {
            const saved = localStorage.getItem("gtk_v7_ent");
            if (saved) { currentUser = JSON.parse(saved); initApp(); }
            document.getElementById("repMonth").value = String(new Date().getMonth() + 1).padStart(2, '0');
        };

        function switchTab(name) {
            document.querySelectorAll(".view-section").forEach(el => el.classList.add("hidden"));
            document.getElementById("view-" + name).classList.remove("hidden");
            
            // Update Bottom Nav Active State
            document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
            const navId = "nav-" + (name === "data" ? "data" : name); // Handle mapping
            const navEl = document.getElementById(navId);
            if(navEl) navEl.classList.add("active");
        }

        function setBtnLoading(id, loading, text="") {
            const btn = document.getElementById(id);
            if(loading) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>'; }
            else { btn.disabled = false; btn.innerHTML = text; }
        }

        async function handleLogin(e) {
            e.preventDefault(); setBtnLoading("btnLogin", true);
            try {
                const res = await fetchAPI({ action: "login", email: document.getElementById("email").value, pin: document.getElementById("pin").value });
                if (res.status === "success") { currentUser = res; localStorage.setItem("gtk_v7_ent", JSON.stringify(res)); initApp(); }
                else Swal.fire("Gagal", res.message, "error");
            } catch (err) { Swal.fire("Error", "Koneksi Bermasalah", "error"); }
            setBtnLoading("btnLogin", false, "Masuk Aplikasi");
        }

        function initApp() {
            document.getElementById("loginPage").classList.add("hidden");
            document.getElementById("dashboardPage").classList.remove("hidden");
            document.getElementById("headerName").innerText = currentUser.user.nama;
            document.getElementById("headerUnit").innerText = currentUser.user.unit;

            if(currentUser.user.role === "Kepala Sekolah" || currentUser.user.role === "Admin") {
                document.getElementById("nav-monitoring").classList.remove("hidden");
            }
            // Default load tab upload
            switchTab('upload');
        }

        function confirmLogout() {
            Swal.fire({ title: 'Keluar?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#0f172a', confirmButtonText: 'Ya' })
            .then((r)=>{if(r.isConfirmed){localStorage.removeItem("gtk_v7_ent");location.reload();}});
        }

        async function fetchAPI(data){ 
            const r = await fetch(GAS_API_URL,{method:"POST",body:JSON.stringify(data)}); 
            return await r.json(); 
        }

        // --- DATA JURNAL (Card View) ---
        async function loadJournalData() {
            switchTab("data");
            const list = document.getElementById("journalList");
            list.innerHTML = `<div class="text-center py-10 text-slate-400"><i class="fas fa-circle-notch fa-spin text-2xl"></i><p class="text-xs mt-2">Memuat data...</p></div>`;
            
            const r = await fetchAPI({action:"fetch_journal", dbId:currentUser.user.dbId});
            if(r.status==="success"){ 
                allJournalData=r.data; populateYear(); applyFilter(); 
            } else list.innerHTML = `<div class="text-center py-10 text-red-400">Gagal mengambil data</div>`;
        }

        function populateYear() {
            const s = new Set(); 
            allJournalData.forEach(i=> { let p=i.tgl.split(/[\s/-]/); if(p.length>=3) s.add(p[2]); });
            const el = document.getElementById("filterYear"); el.innerHTML='<option value="all">Tahun</option>';
            Array.from(s).sort().reverse().forEach(v => el.innerHTML+=`<option value="${v}">${v}</option>`);
        }

        function applyFilter() {
            const fY = document.getElementById("filterYear").value;
            const fM = document.getElementById("filterMonth").value;
            const fS = document.getElementById("searchData").value.toLowerCase();
            
            const monthMap = { "jan":"01", "feb":"02", "mar":"03", "apr":"04", "may":"05", "jun":"06", "jul":"07", "aug":"08", "sep":"09", "oct":"10", "nov":"11", "dec":"12", "mei":"05", "agt":"08", "agu":"08", "okt":"10", "des":"12", "januari":"01", "februari":"02", "maret":"03", "juni":"06", "juli":"07", "agustus":"08", "oktober":"10", "desember":"12" };

            filteredJournalData = allJournalData.filter(i => {
                let parts = i.tgl.split(/[\s/-]/);
                if (parts.length < 3) return true;
                let m = monthMap[parts[1].toLowerCase()] || parts[1];
                return ((fY==="all" || parts[2]===fY) && (fM==="all" || m===fM) && (i.kegiatan.toLowerCase().includes(fS)));
            });
            renderList();
        }

        function renderList() {
            const list = document.getElementById("journalList");
            if(filteredJournalData.length===0){ list.innerHTML=`<div class="text-center py-10 text-slate-400 text-sm">Data tidak ditemukan</div>`; return;}
            
            // Limit 50 item terakhir agar ringan di HP
            list.innerHTML = filteredJournalData.slice(0, 50).map(r => `
                <div class="journal-card relative pl-4">
                    <div class="absolute left-0 top-4 bottom-4 w-1 bg-blue-500 rounded-r"></div>
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs font-bold text-blue-600 block">${r.tgl}</span>
                            <span class="text-[10px] text-slate-400 font-mono">${r.waktu||'-'}</span>
                        </div>
                        ${r.dok && r.dok.length>5 ? `<a href="${r.dok}" target="_blank" class="text-blue-500 bg-blue-50 p-1.5 rounded-lg"><i class="fas fa-external-link-alt text-xs"></i></a>` : ''}
                    </div>
                    <p class="text-sm font-bold text-slate-800 mb-1 leading-snug">${r.kegiatan}</p>
                    <p class="text-xs text-slate-500">${r.hasil||'-'}</p>
                </div>`).join("");
        }

        // --- UPLOAD ---
        function previewFile(){ const f=document.getElementById("fileInput").files[0]; if(f){ document.getElementById("dropzone").classList.add("hidden"); document.getElementById("filePreview").classList.remove("hidden"); document.getElementById("fileName").innerText=f.name; document.getElementById("btnUpload").disabled=false; document.getElementById("btnUpload").className="mt-6 w-full py-3 rounded-xl font-bold text-sm bg-slate-900 text-white shadow-lg"; document.getElementById("btnUpload").innerText="Kirim Data"; } }
        function clearFile(){ document.getElementById("fileInput").value=""; document.getElementById("dropzone").classList.remove("hidden"); document.getElementById("filePreview").classList.add("hidden"); document.getElementById("btnUpload").disabled=true; document.getElementById("btnUpload").className="mt-6 w-full py-3 rounded-xl font-bold text-sm bg-slate-200 text-slate-400 transition cursor-not-allowed"; }
        async function handleUpload(){ const f=document.getElementById("fileInput").files[0]; if(!f)return; setBtnLoading("btnUpload",true); const r=new FileReader(); r.onload=async(e)=>{ const res=await fetchAPI({action:"upload",email:currentUser.user.email,fileName:f.name,fileData:e.target.result.split(",")[1]}); if(res.status==="success"){Swal.fire("Berhasil","Terkirim.","success");clearFile();}else Swal.fire("Gagal",res.message,"error"); setBtnLoading("btnUpload",false,"Kirim Data"); }; r.readAsDataURL(f); }

        // --- MONITORING ---
        async function loadMonitoringData() {
            switchTab("monitoring");
            const area = document.getElementById("ksListArea");
            area.innerHTML = `<div class="text-center py-10 text-slate-400"><i class="fas fa-circle-notch fa-spin"></i></div>`;
            const res = await fetchAPI({ action: "fetch_school_data", unit: currentUser.user.unit, email: currentUser.user.email, role: currentUser.user.role, filterUnit: "all" });
            if(res.status === "success") { allTeachers = res.teachers; renderTeacherList(allTeachers); }
        }

        function renderTeacherList(list) {
            const area = document.getElementById("ksListArea");
            if(list.length===0) { area.innerHTML = `<div class="text-center py-10 text-slate-400 text-sm">Kosong.</div>`; return; }
            area.innerHTML = list.map(t => `
                <div class="bg-white border border-slate-200 p-4 rounded-xl flex justify-between items-center shadow-sm">
                    <div>
                        <h4 class="font-bold text-slate-800 text-sm truncate w-40">${t.nama}</h4>
                        <span class="text-[10px] px-2 py-0.5 rounded ${t.hasDb?'bg-green-100 text-green-700':'bg-red-100 text-red-600'} font-bold">${t.hasDb?'AKTIF':'NON-AKTIF'}</span>
                    </div>
                </div>`).join("");
        }
        function filterTeachers() { const k=document.getElementById("searchGuru").value.toLowerCase(); renderTeacherList(allTeachers.filter(t=>t.nama.toLowerCase().includes(k))); }

        // --- LAPORAN ---
        function toggleMonthSelect(){ document.getElementById("monthContainer").className = document.getElementById("repType").value==="bulanan"?"flex gap-2":"hidden"; }
        async function downloadReport(){ setBtnLoading("btnDownload",true); try{ const r=await fetchAPI({action:"download_report",email:currentUser.user.email,type:document.getElementById("repType").value,month:document.getElementById("repMonth").value,year:document.getElementById("repYear").value}); if(r.status==="success")window.open(r.downloadUrl,"_blank"); else Swal.fire("Gagal",r.message,"warning"); }catch(e){} setBtnLoading("btnDownload",false,'<i class="fas fa-download"></i> Download'); }
    </script>
</body>
</html>
